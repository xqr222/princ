<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>航空货运定价决策系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <!-- <link rel="stylesheet" href="static/styles.css"> --> <!-- Removed link to missing file -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.47/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <!-- 引入API客户端 -->
    <script src="static/api-client.js"></script>
    <style>
        .model-card {
            transition: transform 0.3s;
            height: 100%;
            cursor: pointer;
        }
        .model-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .nav-pills .nav-link.active {
            background-color: #0d6efd;
        }
        .sidebar {
            height: calc(100vh - 56px);
            position: sticky;
            top: 56px;
        }
        .content-area {
            min-height: calc(100vh - 56px);
        }
        .model-settings {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
        }
        .model-settings.show {
            max-height: 2000px;
        }
        .result-panel {
            border-left: 4px solid #0d6efd;
        }
    </style>
    <!-- 检查CSS和JS路径是否正确 -->
    <link href="static/css/style.css" rel="stylesheet">
    <script src="static/js/script.js"></script>
</head>
<body class="bg-light">
    <div id="app">
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">
                    <i class="bi bi-airplane"></i> 航空货运动态定价系统
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link active" href="#">首页</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">历史记录</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">数据分析</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container-fluid">
            <div class="row">
                <!-- 侧边栏导航 -->
                <div class="col-lg-2 d-none d-lg-block bg-white sidebar p-0">
                    <div class="list-group list-group-flush pt-3">
                        <a href="#" class="list-group-item list-group-item-action" :class="{ active: activeView === 'dashboard' }" @click.prevent="setActiveView('dashboard')">
                            <i class="bi bi-house-door me-2"></i> 价格仪表板
                        </a>
                        <div class="list-group-item list-group-item-primary fw-bold">定价模型</div>
                        <a href="#" class="list-group-item list-group-item-action" :class="{ active: activeView === 'elasticity' }" @click.prevent="setActiveView('elasticity')">
                            <i class="bi bi-graph-up me-2"></i> 需求弹性模型
                        </a>
                        <a href="#" class="list-group-item list-group-item-action" :class="{ active: activeView === 'gametheory' }" @click.prevent="setActiveView('gametheory')">
                            <i class="bi bi-diagram-3 me-2"></i> 博弈论模型
                        </a>
                        <a href="#" class="list-group-item list-group-item-action" :class="{ active: activeView === 'dynamicprogramming' }" @click.prevent="setActiveView('dynamicprogramming')">
                            <i class="bi bi-cpu me-2"></i> 动态规划模型
                        </a>
                        <div class="list-group-item list-group-item-primary fw-bold">航线配置</div>
                        <a href="#" class="list-group-item list-group-item-action" :class="{ active: activeView === 'route' }" @click.prevent="setActiveView('route')">
                            <i class="bi bi-map me-2"></i> 航线管理
                        </a>
                        <a href="#" class="list-group-item list-group-item-action" :class="{ active: activeView === 'aircraft' }" @click.prevent="setActiveView('aircraft')">
                            <i class="bi bi-airplane me-2"></i> 机型管理
                        </a>
                    </div>
                </div>

                <!-- 主要内容区域 -->
                <div class="col-lg-10 content-area py-4">
                    <div class="container">
                        <!-- 仪表板视图 -->
                        <div v-if="activeView === 'dashboard'">
                            <h2 class="mb-4">系统仪表盘</h2>
                            
                            <!-- 移除旧的三个模型摘要卡片 -->

                            <!-- 新增：交互式配置与综合最优价格 -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">综合最优价格查询</h5>
                                        </div>
                                        <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <label for="dashboardRouteSelect" class="form-label">选择航线</label>
                                            <select id="dashboardRouteSelect" class="form-select form-select-sm" v-model.number="dashboardConfig.selectedRouteIndex">
                                                <option v-for="(route, index) in routeOptions" :value="index">
                                                    {% raw %}{{ route.origin }} -> {{ route.destination }} ({{ route.distance }}km){% endraw %}
                                                </option>
                                            </select>
                                            </div>
                                        <div class="col-md-4">
                                            <label for="dashboardAircraftSelect" class="form-label">选择机型</label>
                                            <select id="dashboardAircraftSelect" class="form-select form-select-sm" v-model="dashboardConfig.selectedAircraftType">
                                                <option v-for="aircraft in aircraftOptions" :value="aircraft.type">
                                                    {% raw %}{{ aircraft.type }} (载重: {{ aircraft.max_payload }}kg){% endraw %}
                                                </option>
                                            </select>
                                            </div>
                                         <!-- 修改: 日期选择 -->
                                         <div class="col-md-4">
                                            <label for="dashboardSelectedDate" class="form-label">选择预订开始日期</label>
                                            <input type="date" id="dashboardSelectedDate" class="form-control form-control-sm"
                                                   v-model="dashboardConfig.selectedDate"
                                                   :min="getFormattedDate(new Date())">
                                            <small class="text-muted">您选择的日期将用于定位一个从特定基准日(如5月1日)开始、每14天为一个周期的预订窗口。价格将按此14天周期显示。</small>
                                            </div>
                                        </div>
                                    <!-- 移除旧的日期范围筛选 -->
                                    <!-- <div class="row mb-3"> ... </div> -->
                                
                                    <!-- 修改后的显示区域：只显示选定日期的价格 -->
                                    <div v-if="dashboardLoading" class="mt-3 border-top pt-3 text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2">{% raw %}{{ bestPriceDashboard.message || '正在计算最新价格，请稍候...' }}{% endraw %}</p>
                                            </div>
                                    <div v-else-if="bestPriceDashboard.isDataValid && bestPriceDashboard.selectedDayPrices && bestPriceDashboard.selectedDayPrices.length > 0" class="mt-3 border-top pt-3">
                                        <!-- 修改: 显示选定日期 -->
                                        <h6 class="mb-3">日期 {% raw %}{{ dashboardConfig.selectedDate }}{% endraw %} (预订期第 {% raw %}{{ calculateDaysUntilDeparture(dashboardConfig.selectedDate, dashboardConfig.bookingStartDate) }}{% endraw %} 天 / 共14天) 综合最优价格</h6>
                                        <p class="text-muted small mb-2">数据更新: {% raw %}{{ bestPriceDashboard.lastUpdated ? new Date(bestPriceDashboard.lastUpdated).toLocaleString() : 'N/A' }}{% endraw %}</p>
                                        <div class="row">
                                            <div v-for="(item, index) in bestPriceDashboard.selectedDayPrices" :key="index" class="col-md-4 mb-2">
                                                <div class="card h-100">
                                                     <div class="card-header text-center fw-bold">{% raw %}{{ item.cargoType }}{% endraw %}</div>
                                                    <div class="card-body text-center">
                                                        <h4 class="card-title">{% raw %}{{ item.bestPrice !== null ? item.bestPrice.toFixed(2) : 'N/A' }}{% endraw %} 元/kg</h4>
                                                        <p class="card-text mb-0">
                                                             <span :class="{'badge': true, 'bg-primary': item.source === '弹性', 'bg-success': item.source === '动态规划', 'bg-secondary': !item.source}">{% raw %}{{ item.source || '无' }}{% endraw %}</span>
                                                             <small class="text-muted d-block">来源模型</small>
                                                        </p>
                                            </div>
                                            </div>
                                        </div>
                                        </div>
                                    </div>
                                    <div v-else class="mt-3 border-top pt-3">
                                        <div class="alert alert-info">
                                             <i class="bi bi-info-circle me-2"></i> 
                                             {% raw %}{{ bestPriceDashboard.message || '请选择配置并确保已运行相关模型。' }}{% endraw %}
                                </div>
                                        </div>
                                </div>
                            </div>
                            
                            <!-- 收益分析和利用率 (保持不变) -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">收益比较</h5>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="dashboardRevenueChart" height="250"></canvas>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">资源利用率</h5>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="dashboardUtilizationChart" height="250"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 模型比较 (保持不变) -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">模型比较详情</h5>
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-sm btn-outline-primary active" id="btn-price-optimization">价格优化</button>
                                                <button type="button" class="btn btn-sm btn-outline-primary" id="btn-computation-speed">计算速度</button>
                                                <button type="button" class="btn btn-sm btn-outline-primary" id="btn-market-sensitivity">市场敏感度</button>
                                                <button type="button" class="btn btn-sm btn-outline-primary" id="btn-prediction-accuracy">预测准确度</button>
                                                <button type="button" class="btn btn-sm btn-outline-primary" id="btn-adaptability">适应性</button>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <!-- 每个比较维度的容器 -->
                                            <div id="price-optimization-container" class="comparison-container">
                                                <h5 class="text-center mb-3">价格优化能力比较</h5>
                                                <div class="row">
                                                    <div class="col-md-8">
                                                        <canvas id="priceOptimizationChart" height="300"></canvas>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="card border-light mb-3">
                                                            <div class="card-body">
                                                                <h5 class="card-title">指标说明</h5>
                                                                <p class="card-text">价格优化能力指模型找到最优价格的准确性和效率。</p>
                                                                <ul>
                                                                    <li><strong>动态规划模型</strong>: 考虑多种约束和长期影响，优化效果最佳</li>
                                                                    <li><strong>博弈论模型</strong>: 考虑竞争对手的行为，在竞争环境中表现良好</li>
                                                                    <li><strong>需求弹性模型</strong>: 仅考虑价格弹性关系，实现简单但精度有限</li>
                                                                </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                                            <div id="computation-speed-container" class="comparison-container" style="display:none;">
                                                <h5 class="text-center mb-3">计算速度比较</h5>
                                                <div class="row">
                                                    <div class="col-md-8">
                                                        <canvas id="computationSpeedChart" height="300"></canvas>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="card border-light mb-3">
                                                            <div class="card-body">
                                                                <h5 class="card-title">指标说明</h5>
                                                                <p class="card-text">计算速度指模型执行和求解所需的时间。</p>
                                                                <ul>
                                                                    <li><strong>需求弹性模型</strong>: 计算简单，速度最快</li>
                                                                    <li><strong>博弈论模型</strong>: 需要迭代求解纳什均衡，速度中等</li>
                                                                    <li><strong>动态规划模型</strong>: 需要处理大量状态和约束，计算较慢</li>
                                                                </ul>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div id="market-sensitivity-container" class="comparison-container" style="display:none;">
                                                <h5 class="text-center mb-3">市场敏感度比较</h5>
                                                <div class="row">
                                                    <div class="col-md-8">
                                                        <canvas id="marketSensitivityChart" height="300"></canvas>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="card border-light mb-3">
                                                            <div class="card-body">
                                                                <h5 class="card-title">指标说明</h5>
                                                                <p class="card-text">市场敏感度指模型对市场变化的响应能力。</p>
                                                                <ul>
                                                                    <li><strong>博弈论模型</strong>: 擅长处理竞争环境变化，响应迅速</li>
                                                                    <li><strong>动态规划模型</strong>: 可适应多种市场条件，但调整相对较慢</li>
                                                                    <li><strong>需求弹性模型</strong>: 主要关注价格和需求关系，对复杂市场变化反应有限</li>
                                                                </ul>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div id="prediction-accuracy-container" class="comparison-container" style="display:none;">
                                                <h5 class="text-center mb-3">预测准确度比较</h5>
                                                <div class="row">
                                                    <div class="col-md-8">
                                                        <canvas id="predictionAccuracyChart" height="300"></canvas>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="card border-light mb-3">
                                                            <div class="card-body">
                                                                <h5 class="card-title">指标说明</h5>
                                                                <p class="card-text">预测准确度指模型预测未来趋势的准确性。</p>
                                                                <ul>
                                                                    <li><strong>动态规划模型</strong>: 考虑长期影响和多种约束，预测最准确</li>
                                                                    <li><strong>博弈论模型</strong>: 考虑竞争动态，对市场竞争预测较准</li>
                                                                    <li><strong>需求弹性模型</strong>: 着重短期价格-需求关系，预测范围有限</li>
                                                                </ul>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div id="adaptability-container" class="comparison-container" style="display:none;">
                                                <h5 class="text-center mb-3">适应性比较</h5>
                                                <div class="row">
                                                    <div class="col-md-8">
                                                        <canvas id="adaptabilityChart" height="300"></canvas>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="card border-light mb-3">
                                                            <div class="card-body">
                                                                <h5 class="card-title">指标说明</h5>
                                                                <p class="card-text">适应性指模型应对不同市场条件的能力。</p>
                                                                <ul>
                                                                    <li><strong>动态规划模型</strong>: 能够处理多种约束和市场状况，适应性最强</li>
                                                                    <li><strong>需求弹性模型</strong>: 简单且易于调整，但功能有限</li>
                                                                    <li><strong>博弈论模型</strong>: 对竞争对手行为变化敏感，在非竞争环境下表现较弱</li>
                                                                </ul>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 需求弹性模型视图 -->
                        <div v-if="activeView === 'elasticity'">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h2>需求弹性模型</h2>
                                <div>
                                    <button class="btn btn-outline-secondary me-2" @click="elasticityView = elasticityView === 'config' ? 'results' : 'config'" v-if="elasticityView !== 'loading'">
                                        <i class="bi" :class="elasticityView === 'config' ? 'bi-eye' : 'bi-gear'"></i>
                                        {% raw %}{{ elasticityView === 'config' ? '查看结果' : '修改参数' }}{% endraw %}
                                    </button>
                                    <button class="btn btn-primary" @click="runElasticityModel" v-if="elasticityView === 'config'">
                                        <i class="bi bi-play-fill me-1"></i> 运行模型
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 参数配置界面 -->
                            <div v-if="elasticityView === 'config'">
                                <div class="alert alert-info" v-if="aircraftInfo.type">
                                    <i class="bi bi-info-circle me-2"></i> {% raw %}当前使用机型 <strong>{{ aircraftInfo.type }}</strong> (最大载重: {{ aircraftInfo.max_payload }}kg){% endraw %}
                                </div>
                                <div class="card mb-4">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0">
                                            <i class="bi bi-sliders me-2"></i> 模型参数设置
                                        </h5>
                                    </div>
                                    
                                    <div class="card-body">
                                        <!-- 需求弹性模型参数 -->
                                        <div>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">货物类型</label>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" v-model="elasticity.cargoTypes.express" id="express">
                                                            <label class="form-check-label" for="express">快件</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" v-model="elasticity.cargoTypes.fresh" id="fresh">
                                                            <label class="form-check-label" for="fresh">鲜活</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" v-model="elasticity.cargoTypes.regular" id="regular">
                                                            <label class="form-check-label" for="regular">普货</label>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">预订期设置</label>
                                                        <div>
                                                            <label class="form-label">预订期长度 (天)</label>
                                                            <!-- 修改: 改为只读显示 -->
                                                            <input type="number" class="form-control-plaintext" :value="bookingPeriodDisplay" readonly>
                                                            <small class="text-muted">模型将计算一个通用的 {% raw %}{{ bookingPeriodDisplay }}{% endraw %} 天价格模式。此模式将应用于仪表盘中选定的具体预订日期范围。</small>
                                                            <!-- 移除: 旧的滑块和日期输入 -->
                                                            <!-- <input type="range" class="form-range" ...> -->
                                                            <!-- <div class="row mt-2"> ... </div> -->
                                                            </div>
                                                        </div>
                                                </div>
                                            </div>
                                            
                                            <div class="row mt-3">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">价格弹性系数 (快件)</label>
                                                        <input type="range" class="form-range" min="-3" max="-0.5" step="0.1" v-model="elasticity.priceElasticity.express">
                                                        <div class="d-flex justify-content-between">
                                                            <small>高弹性 (-3.0)</small>
                                                            <small>{% raw %}{{ elasticity.priceElasticity.express }}{% endraw %}</small>
                                                            <small>低弹性 (-0.5)</small>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">快件初始价格 (元/kg)</label>
                                                        <input type="number" class="form-control" v-model="elasticity.initialPrices.express" readonly>
                                                        <!-- Removed comment: <small class="text-muted">此值由机型配置自动设置</small> -->
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">价格弹性系数 (鲜活)</label>
                                                        <input type="range" class="form-range" min="-3" max="-0.5" step="0.1" v-model="elasticity.priceElasticity.fresh">
                                                        <div class="d-flex justify-content-between">
                                                            <small>高弹性 (-3.0)</small>
                                                            <small>{% raw %}{{ elasticity.priceElasticity.fresh }}{% endraw %}</small>
                                                            <small>低弹性 (-0.5)</small>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">鲜活初始价格 (元/kg)</label>
                                                        <input type="number" class="form-control" v-model="elasticity.initialPrices.fresh" readonly>
                                                        <!-- Removed comment: <small class="text-muted">此值由机型配置自动设置</small> -->
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">价格弹性系数 (普货)</label>
                                                        <input type="range" class="form-range" min="-3" max="-0.5" step="0.1" v-model="elasticity.priceElasticity.regular">
                                                        <div class="d-flex justify-content-between">
                                                            <small>高弹性 (-3.0)</small>
                                                            <small>{% raw %}{{ elasticity.priceElasticity.regular }}{% endraw %}</small>
                                                            <small>低弹性 (-0.5)</small>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">普货初始价格 (元/kg)</label>
                                                        <input type="number" class="form-control" v-model="elasticity.initialPrices.regular" readonly>
                                                        <!-- Removed comment: <small class="text-muted">此值由机型配置自动设置</small> -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="card-footer d-flex justify-content-between">
                                        <button class="btn btn-secondary" @click="resetModelParams('elasticity')">重置参数</button>
                                        <button class="btn btn-primary" @click="runElasticityModelAndShowResults()">运行模型</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 弹性模型结果区域 -->
                            <div v-if="elasticityView === 'results' && modelResults.elasticity">
                                <div class="card mb-4">
                                    <div class="card-header bg-success text-white">
                                        <h5 class="mb-0">
                                            <i class="bi bi-bar-chart-line me-2"></i> 定价结果
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-8">
                                                <h5 class="mb-3">最优价格</h5>
                                                <div class="table-responsive">
                                                    <table class="table table-bordered table-hover">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th>货物类型</th>
                                                                <th>初始价格</th>
                                                                <th>最优价格</th>
                                                                <th>变化</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr v-for="(result, idx) in modelResults.elasticity.priceTable">
                                                                <td>{% raw %}{{ result.cargoType }}{% endraw %}</td>
                                                                <td>{% raw %}{{ Number(result.initialPrice).toFixed(2) }}{% endraw %} 元/kg</td>
                                                                <td>{% raw %}{{ Number(result.optimalPrice).toFixed(2) }}{% endraw %} 元/kg</td>
                                                                <td :class="result.change >= 0 ? 'text-success' : 'text-danger'">
                                                                    {% raw %}{{ result.change >= 0 ? '+' : '' }}{% endraw %}{% raw %}{{ Number(result.change).toFixed(1) }}{% endraw %}%
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                                
                                                <!-- 预订期阶段价格表 -->
                                                <div v-if="modelResults.elasticity.bookingStagePriceTable">
                                                    <h5 class="mb-3 mt-4">预订期阶段价格表 ({% raw %}{{ modelResults.elasticity.bookingPeriod }}{% endraw %}天)</h5>
                                                    <div class="table-responsive">
                                                        <table class="table table-bordered table-hover">
                                                            <thead class="table-light">
                                                                <tr>
                                                                    <th>货物类型</th>
                                                                    <th v-for="stage in modelResults.elasticity.bookingStages">
                                                                        {% raw %}{{ getBookingStageName(stage-1) }}{% endraw %}
                                                                    </th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr v-for="(result, idx) in modelResults.elasticity.bookingStagePriceTable">
                                                                    <td>{% raw %}{{ result.cargoType }}{% endraw %}</td>
                                                                    <td v-for="stage in modelResults.elasticity.bookingStages">
                                                                        {% raw %}{{ Number(result[getBookingStageName(stage-1) + 'Price']).toFixed(2) }}{% endraw %} 元/kg
                                                                    </td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    
                                                    <!-- 阶段收益比较 -->
                                                    <div v-if="modelResults.elasticity.stageRevenues" class="mt-4">
                                                        <h5 class="mb-3">阶段收益比较</h5>
                                                        <div class="d-flex justify-content-around">
                                                            <div v-for="(revenue, idx) in modelResults.elasticity.stageRevenues" class="text-center">
                                                                <div class="border rounded p-3">
                                                                    <h6>{% raw %}{{ getBookingStageName(idx) }}{% endraw %}</h6>
                                                                    <h4 class="text-primary">{% raw %}{{ revenue.toLocaleString() }}{% endraw %} 元</h4>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <h5 class="mb-3">收益分析</h5>
                                                <div class="card bg-light">
                                                    <div class="card-body">
                                                        <div class="mb-3">
                                                            <h6>初始价格总收益</h6>
                                                            <h3 class="text-muted">{% raw %}{{ modelResults.elasticity.initial_revenue }}{% endraw %} 元</h3>
                                                        </div>
                                                        <div class="mb-3">
                                                            <h6>最优价格总收益</h6>
                                                            <h3 class="text-primary">{% raw %}{{ modelResults.elasticity.optimal_revenue }}{% endraw %} 元</h3>
                                                        </div>
                                                        <div>
                                                            <h6>收益提升</h6>
                                                            <h3 class="text-success">{% raw %}{{ elasticityRevenueIncreaseDisplay }}{% endraw %}</h3>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row mt-4">
                                            <div class="col-12" style="height: 350px;"> <!-- Added height style -->
                                                <h5 class="mb-3">价格弹性分析</h5>
                                                <canvas id="elasticityChart"></canvas> <!-- Removed height attribute -->
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-footer">
                                        <button class="btn btn-primary" @click="elasticityView = 'config'">
                                            <i class="bi bi-arrow-left me-1"></i> 返回修改参数
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 博弈论模型视图 -->
                        <div v-if="activeView === 'gametheory'">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h2>航空货运博弈论模型</h2>
                                <div>
                                    <button class="btn btn-outline-secondary me-2" @click="gametheoryView = gametheoryView === 'config' ? 'results' : 'config'" v-if="gametheoryView !== 'loading'">
                                        <i class="bi" :class="gametheoryView === 'config' ? 'bi-eye' : 'bi-gear'"></i>
                                        {% raw %}{{ gametheoryView === 'config' ? '查看结果' : '修改参数' }}{% endraw %}
                                    </button>
                                    <button class="btn btn-primary" @click="runGameTheoryModel" v-if="gametheoryView === 'config'">
                                        <i class="bi bi-play-fill me-1"></i> 运行模型
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 参数配置界面 -->
                            <div v-if="gametheoryView === 'config'">
                                <div class="alert alert-info" v-if="aircraftInfo.type">
                                    <i class="bi bi-info-circle me-2"></i> {% raw %}当前使用机型 <strong>{{ aircraftInfo.type }}</strong> (最大载重: {{ aircraftInfo.max_payload }}kg){% endraw %}
                                </div>
                                <div class="card mb-4">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0">
                                            <i class="bi bi-sliders me-2"></i> 模型参数设置
                                        </h5>
                                    </div>
                                    
                                    <div class="card-body">
                                        <!-- 博弈论模型参数 -->
                                        <div>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">时段数量</label>
                                                        <input type="range" class="form-range" min="5" max="50" step="5" v-model.number="gametheory.timePeriods">
                                                        <div class="d-flex justify-content-between">
                                                            <small>5</small>
                                                            <small>{% raw %}{{ gametheory.timePeriods }}{% endraw %}</small>
                                                            <small>50</small>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">参与航空公司</label>
                                                        <div class="input-group mb-2">
                                                            <span class="input-group-text">公司1</span>
                                                            <input type="text" class="form-control" v-model="gametheory.companies[0].name" readonly>
                                                        </div>
                                                        <div class="input-group mb-2">
                                                            <span class="input-group-text">容量</span>
                                                            <input type="number" class="form-control" v-model="gametheory.companies[0].initial_capacity" readonly>
                                                            <span class="input-group-text">kg</span>
                                                        </div>
                                                        <small class="text-muted">此值由机型配置自动设置</small>
                                                        <div class="input-group mb-2">
                                                            <span class="input-group-text">公司2</span>
                                                            <input type="text" class="form-control" v-model="gametheory.companies[1].name" readonly>
                                                        </div>
                                                        <div class="input-group mb-2">
                                                            <span class="input-group-text">容量</span>
                                                            <input type="number" class="form-control" v-model="gametheory.companies[1].initial_capacity" readonly>
                                                            <span class="input-group-text">kg</span>
                                                        </div>
                                                        <small class="text-muted">此值由机型配置自动设置</small>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">K值 (价格影响因子)</label>
                                                <div class="form-text mb-2">K值表示需求受自身价格影响程度与受竞争对手价格影响程度的比值</div>
                                                <input type="range" class="form-range" min="0.5" max="2" step="0.1" v-model.number="gametheory.kValue">
                                                <div class="d-flex justify-content-between">
                                                    <small>0.5</small>
                                                    <small>{% raw %}{{ gametheory.kValue }}{% endraw %}</small>
                                                    <small>2</small>
                                                </div>
                                            </div>
                                            
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">初始价格 (公司1, 元/kg)</label>
                                                        <input type="number" class="form-control" v-model="gametheory.companies[0].initialPrice" readonly>
                                                        <!-- Removed comment: <small class="text-muted">此值由机型配置自动设置</small> -->
                                                    </div>
                                                </div>
                                                
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">初始价格 (公司2, 元/kg)</label>
                                                        <input type="number" class="form-control" v-model="gametheory.companies[1].initialPrice" readonly>
                                                        <!-- Removed comment: <small class="text-muted">此值由机型配置自动设置</small> -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="card-footer d-flex justify-content-between">
                                        <button class="btn btn-secondary" @click="resetModelParams('gametheory')">重置参数</button>
                                        <button class="btn btn-primary" @click="runGameTheoryModelAndShowResults()">运行模型</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 博弈论模型结果区域 -->
                            <div v-if="gametheoryView === 'results' && modelResults.gametheory">
                                <div class="card mb-4">
                                    <div class="card-header bg-success text-white">
                                        <h5 class="mb-0">
                                            <i class="bi bi-bar-chart-line me-2"></i> 定价结果
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-8">
                                                <h5 class="mb-3">纳什均衡定价策略</h5>
                                                <div class="table-responsive">
                                                    <table class="table table-bordered table-hover">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th>#</th>
                                                                <th v-if="modelResults.gametheory && modelResults.gametheory.companiesForChart && modelResults.gametheory.companiesForChart.length > 0">
                                                                    {% raw %}{{ modelResults.gametheory.companiesForChart[0].name }}{% endraw %} 价格
                                                                </th>
                                                                <th v-if="modelResults.gametheory && modelResults.gametheory.companiesForChart && modelResults.gametheory.companiesForChart.length > 1">
                                                                    {% raw %}{{ modelResults.gametheory.companiesForChart[1].name }}{% endraw %} 价格
                                                                </th>
                                                                <th>公司1收益</th>
                                                                <th>公司2收益</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr v-for="(result, idx) in modelResults.gametheory.priceTable">
                                                                <td>{% raw %}{{ idx + 1 }}{% endraw %}</td>
                                                                <td>{% raw %}{{ Number(result.price1).toFixed(2) }}{% endraw %} 元/kg</td>
                                                                <td>{% raw %}{{ Number(result.price2).toFixed(2) }}{% endraw %} 元/kg</td>
                                                                <td>{% raw %}{{ Number(result.revenue1).toLocaleString() }}{% endraw %} 元</td>
                                                                <td>{% raw %}{{ Number(result.revenue2).toLocaleString() }}{% endraw %} 元</td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <h5 class="mb-3">收益分析</h5>
                                                <div class="card bg-light">
                                                    <div class="card-body">
                                                        <div class="mb-3" v-if="modelResults.gametheory && modelResults.gametheory.companiesForChart && modelResults.gametheory.companiesForChart.length > 0">
                                                            <h6>{% raw %}{{ modelResults.gametheory.companiesForChart[0].name }}{% endraw %} 收益</h6>
                                                            <h3 class="text-primary">{% raw %}{{ Number(modelResults.gametheory.companiesForChart[0].totalRevenue).toFixed(2) }}{% endraw %} 元</h3>
                                                        </div>
                                                        <div class="mb-3" v-if="modelResults.gametheory && modelResults.gametheory.companiesForChart && modelResults.gametheory.companiesForChart.length > 1">
                                                            <h6>{% raw %}{{ modelResults.gametheory.companiesForChart[1].name }}{% endraw %} 收益</h6>
                                                            <h3 class="text-success">{% raw %}{{ Number(modelResults.gametheory.companiesForChart[1].totalRevenue).toFixed(2) }}{% endraw %} 元</h3>
                                                        </div>
                                                        <div>
                                                            <h6>模拟总收益</h6>
                                                            <h3 class="text-info">{% raw %}{{ Number(modelResults.gametheory.results.total_simulation_revenue).toFixed(2) }}{% endraw %} 元</h3>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row mt-4">
                                            <div class="col-12">
                                                <h5 class="mb-3">价格动态变化</h5>
                                                <div style="height: 400px;">
                                                    <canvas id="gametheoryChart"></canvas>
                                                </div>
                                                <!-- 添加价格变化说明区域 -->
                                                <div class="card bg-light mt-3">
                                                    <div class="card-body">
                                                        <h6 class="mb-2">价格动态过程分析</h6>
                                                        <p>上图展示了两家航空公司在不同时段的价格策略变化。通过博弈论模型分析，可以看出：</p>
                                                        <ul>
                                                            <li>初始阶段，公司之间价格差异较大</li>
                                                            <li>随着时间推移，价格逐渐趋于稳定的纳什均衡点</li>
                                                            <li>最终形成的价格策略可最大化联合收益</li>
                                                        </ul>
                                                        <div class="text-end mt-2">
                                                            <button class="btn btn-sm btn-outline-primary" @click="togglePriceChangeDetail">
                                                                {% raw %}{{ showPriceChangeDetail ? '收起详情' : '查看详细分析' }}{% endraw %}
                                                            </button>
                                                        </div>
                                                        <div v-if="showPriceChangeDetail" class="mt-3">
                                                            <div class="table-responsive">
                                                                <table class="table table-bordered table-sm">
                                                                    <thead class="table-light">
                                                                        <tr>
                                                                            <th>对比项</th>
                                                                            <th v-if="modelResults.gametheory && modelResults.gametheory.companiesForChart && modelResults.gametheory.companiesForChart.length > 0">
                                                                                {% raw %}{{ modelResults.gametheory.companiesForChart[0].name }}{% endraw %}
                                                                            </th>
                                                                            <th v-if="modelResults.gametheory && modelResults.gametheory.companiesForChart && modelResults.gametheory.companiesForChart.length > 1">
                                                                                {% raw %}{{ modelResults.gametheory.companiesForChart[1].name }}{% endraw %}
                                                                            </th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        <tr v-if="modelResults.gametheory && modelResults.gametheory.priceTable && modelResults.gametheory.priceTable.length > 0">
                                                                            <td>初始价格</td>
                                                                            <td>{% raw %}{{ Number(modelResults.gametheory.priceTable[0].price1).toFixed(2) }}{% endraw %} 元/kg</td>
                                                                            <td>{% raw %}{{ Number(modelResults.gametheory.priceTable[0].price2).toFixed(2) }}{% endraw %} 元/kg</td>
                                                                        </tr>
                                                                        <tr v-if="modelResults.gametheory && modelResults.gametheory.priceTable && modelResults.gametheory.priceTable.length > 0">
                                                                            <td>最终价格</td>
                                                                            <td>{% raw %}{{ Number(modelResults.gametheory.priceTable[modelResults.gametheory.priceTable.length-1].price1).toFixed(2) }}{% endraw %} 元/kg</td>
                                                                            <td>{% raw %}{{ Number(modelResults.gametheory.priceTable[modelResults.gametheory.priceTable.length-1].price2).toFixed(2) }}{% endraw %} 元/kg</td>
                                                                        </tr>
                                                                        <tr v-if="modelResults.gametheory && modelResults.gametheory.priceTable && modelResults.gametheory.priceTable.length > 0">
                                                                            <td>价格变化幅度</td>
                                                                            <td>{% raw %}{{ calculatePriceChange(modelResults.gametheory.priceTable, 'price1') }}{% endraw %}%</td>
                                                                            <td>{% raw %}{{ calculatePriceChange(modelResults.gametheory.priceTable, 'price2') }}{% endraw %}%</td>
                                                                        </tr>
                                                                        <!-- <tr>
                                                                            <td>收益变化</td>
                                                                            <td> Placeholder %</td>
                                                                            <td> Placeholder %</td>
                                                                        </tr> -->
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-footer">
                                        <button class="btn btn-primary" @click="gametheoryView = 'config'">
                                            <i class="bi bi-arrow-left me-1"></i> 返回修改参数
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 动态规划模型视图 -->
                        <div v-if="activeView === 'dynamicprogramming'">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h2>航空货运动态规划模型</h2>
                                <div>
                                    <button class="btn btn-outline-secondary me-2" @click="dynamicDPView = dynamicDPView === 'config' ? 'results' : 'config'" v-if="dynamicDPView !== 'loading'">
                                        <i class="bi" :class="dynamicDPView === 'config' ? 'bi-eye' : 'bi-gear'"></i>
                                        {% raw %}{{ dynamicDPView === 'config' ? '查看结果' : '修改参数' }}{% endraw %}
                                    </button>
                                    <button class="btn btn-primary" @click="runDynamicProgrammingModel" v-if="dynamicDPView === 'config'">
                                        <i class="bi bi-play-fill me-1"></i> 运行模型
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 参数配置界面 -->
                            <div v-if="dynamicDPView === 'config'">
                                <div class="alert alert-info" v-if="aircraftInfo.type">
                                    <i class="bi bi-info-circle me-2"></i> {% raw %}当前使用机型 <strong>{{ aircraftInfo.type }}</strong> (最大载重: {{ aircraftInfo.max_payload }}kg, 最大体积: {{ aircraftInfo.max_volume }}cm³){% endraw %}
                                </div>
                                <div class="card mb-4">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0">
                                            <i class="bi bi-sliders me-2"></i> 模型参数设置
                                        </h5>
                                    </div>
                                    
                                    <div class="card-body">
                                        <!-- 动态规划模型参数 -->
                                        <div>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">预订期 (天)</label>
                                                        <!-- 修改: 改为只读 -->
                                                        <input type="number" class="form-control-plaintext" :value="bookingPeriodDisplay" readonly>
                                                        <small class="text-muted">模型将计算一个通用的 {% raw %}{{ bookingPeriodDisplay }}{% endraw %} 天价格模式。此模式将应用于仪表盘中选定的具体预订日期范围。</small>
                                                        <!-- 移除: 旧滑块 -->
                                                        <!-- <input type="range" ...> -->
                                                    </div>
                                                    
                                                    <div class="mb-3">
                                                        <label class="form-label">载重容量 (kg)</label>
                                                        <input type="number" class="form-control" v-model="dynamicDP.capacityWeight" readonly>
                                                        <small class="text-muted">此值由机型配置自动设置</small>
                                                    </div>
                                                    
                                                    <div class="mb-3">
                                                        <label class="form-label">体积容量 (cm³)</label>
                                                        <input type="number" class="form-control" v-model="dynamicDP.capacityVolume" readonly>
                                                        <small class="text-muted">此值由机型配置自动设置</small>
                                                    </div>
                                                </div>
                                                
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">γ 参数 (拉格朗日乘子)</label>
                                                        <div class="form-text mb-2">较小的γ值意味着体积转换为重量时权重更大，更多货物会按体积计费；较大的γ值意味着体积转换为重量时权重更小，更多货物会按实际重量计费</div>
                                                        <input type="range" class="form-range" min="0.5" max="1" step="0.05" v-model.number="dynamicDP.gamma">
                                                        <div class="d-flex justify-content-between">
                                                            <small>0.5</small>
                                                            <small>{% raw %}{{ dynamicDP.gamma }}{% endraw %}</small>
                                                            <small>1</small>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="mb-3">
                                                        <label class="form-label">特征/需求比例 (C/D比例)</label>
                                                        <div class="form-text mb-2">表示航班容量与预期需求的比例。C/D<1时表示供不应求(紧张市场)，需要更高价格控制需求；C/D>1时表示供大于求(宽松市场)，可采用较低价格策略</div>
                                                        <input type="range" class="form-range" min="0.1" max="1" step="0.1" v-model.number="dynamicDP.C_D_ratio">
                                                        <div class="d-flex justify-content-between">
                                                            <small>0.1</small>
                                                            <small>{% raw %}{{ dynamicDP.C_D_ratio }}{% endraw %}</small>
                                                            <small>1</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="card-footer d-flex justify-content-between">
                                        <button class="btn btn-secondary" @click="resetModelParams('dynamicDP')">重置参数</button>
                                        <button class="btn btn-primary" @click="runDynamicDPModelAndShowResults()">运行模型</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 动态规划模型结果区域 -->
                            <div v-if="dynamicDPView === 'results' && modelResults.dynamicDP">
                                <div class="card mb-4">
                                    <div class="card-header bg-success text-white">
                                        <h5 class="mb-0">
                                            <i class="bi bi-bar-chart-line me-2"></i> 定价结果
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-8">
                                                <h5 class="mb-3">动态价格表</h5>
                                                <div class="table-responsive">
                                                    <table class="table table-bordered table-hover">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th>预订类型</th>
                                                                <th>早期价格</th>
                                                                <th>中期价格</th>
                                                                <th>晚期价格</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr v-for="(result, idx) in modelResults.dynamicDP.priceTable">
                                                                <td>{% raw %}{{ result.bookingType }}{% endraw %}</td>
                                                                <td>{% raw %}{{ result.earlyPrice }}{% endraw %} 元/kg</td>
                                                                <td>{% raw %}{{ result.midPrice }}{% endraw %} 元/kg</td>
                                                                <td>{% raw %}{{ result.latePrice }}{% endraw %} 元/kg</td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <h5 class="mb-3">收益分析</h5>
                                                <div class="card bg-light">
                                                    <div class="card-body">
                                                        <div class="mb-3">
                                                            <h6>基准总收益</h6>
                                                            <h3 class="text-muted">{% raw %}{{ modelResults.dynamicDP.baseRevenue }}{% endraw %} 元</h3>
                                                        </div>
                                                        <div class="mb-3">
                                                            <h6>最优总收益</h6>
                                                            <h3 class="text-primary">{% raw %}{{ modelResults.dynamicDP.wvsRevenue }}{% endraw %} 元</h3>
                                                        </div>
                                                        <div class="mb-3">
                                                            <h6>收益增长</h6>
                                                            <h3 class="text-success">+{% raw %}{{ Number(modelResults.dynamicDP.improvement).toFixed(1) }}{% endraw %}%</h3>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="mt-4">
                                                    <h5 class="mb-3">关键性能指标</h5>
                                                    <div class="row">
                                                        <div class="col-6">
                                                            <div class="border rounded p-3 text-center">
                                                                <h6>载重利用率</h6>
                                                                <h3 class="text-primary">{% raw %}{{ modelResults.dynamicDP.weightUtilization }}{% endraw %}%</h3>
                                                            </div>
                                                        </div>
                                                        <div class="col-6">
                                                            <div class="border rounded p-3 text-center">
                                                                <h6>体积利用率</h6>
                                                                <h3 class="text-success">{% raw %}{{ modelResults.dynamicDP.volumeUtilization }}{% endraw %}%</h3>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row mt-4">
                                            <div class="col-12">
                                                <h5 class="mb-3">动态价格策略可视化</h5>
                                                <canvas id="dynamicDPChart" height="250"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-footer">
                                        <button class="btn btn-primary" @click="dynamicDPView = 'config'">
                                            <i class="bi bi-arrow-left me-1"></i> 返回修改参数
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 航线配置视图 -->
                        <div v-if="activeView === 'route'">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h2>航线配置</h2>
                                <button class="btn btn-primary" @click="saveRouteConfig">
                                    <i class="bi bi-save me-1"></i> 保存配置
                                </button>
                    </div>
                            
                            <div class="card mb-4">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">
                                        <i class="bi bi-geo-alt me-2"></i> 路线信息
                                    </h5>
                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">始发地</label>
                                                <input type="text" class="form-control" v-model="routeInfo.origin">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">目的地</label>
                                                <input type="text" class="form-control" v-model="routeInfo.destination">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">竞争程度</label>
                                                <select class="form-select" v-model="routeInfo.competition_level">
                                                    <option value="low">低</option>
                                                    <option value="medium">中</option>
                                                    <option value="high">高</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0">
                                        <i class="bi bi-list me-2"></i> 预设航线
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>始发地</th>
                                                    <th>目的地</th>
                                                    <th>竞争程度</th>
                                                    <th>操作</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr v-for="(route, index) in routeOptions" :key="index">
                                                    <td>{% raw %}{{ route.origin }}{% endraw %}</td>
                                                    <td>{% raw %}{{ route.destination }}{% endraw %}</td>
                                                    <td>{% raw %}{{ route.competition_level }}{% endraw %}</td>
                                                    <td>
                                                        <button class="btn btn-sm btn-outline-primary" @click="loadRoute(route)">
                                                            <i class="bi bi-arrow-clockwise"></i> 加载
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 机型配置视图 -->
                        <div v-if="activeView === 'aircraft'">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h2>机型配置</h2>
                                <button class="btn btn-primary" @click="saveAircraftConfig">
                                    <i class="bi bi-save me-1"></i> 保存配置
                                </button>
                            </div>
                            
                            <div class="card mb-4">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">
                                        <i class="bi bi-airplane me-2"></i> 机型信息
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">机型</label>
                                                <select class="form-select" v-model="aircraftInfo.type">
                                                    <option v-for="aircraft in aircraftOptions" :key="aircraft.type" :value="aircraft.type">
                                                        {% raw %}{{ aircraft.type }}{% endraw %}
                                                    </option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">最大载重 (kg)</label>
                                                <input type="number" class="form-control" v-model="aircraftInfo.max_payload">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">最大体积 (cm³)</label>
                                                <input type="number" class="form-control" v-model="aircraftInfo.max_volume">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0">
                                        <i class="bi bi-list me-2"></i> 预设机型
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>机型</th>
                                                    <th>最大载重</th>
                                                    <th>最大体积</th>
                                                    <th>操作</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr v-for="(aircraft, index) in aircraftOptions" :key="index">
                                                    <td>{% raw %}{{ aircraft.type }}{% endraw %}</td>
                                                    <td>{% raw %}{{ aircraft.max_payload }}kg{% endraw %}</td>
                                                    <td>{% raw %}{{ aircraft.max_volume }}cm³{% endraw %}</td>
                                                    <td>
                                                        <button class="btn btn-sm btn-outline-primary" @click="loadAircraft(aircraft)">
                                                            <i class="bi bi-arrow-clockwise"></i> 加载
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入Bootstrap和Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <script>
        // 配置Chart.js全局设置
        Chart.defaults.animation = {
            duration: 500,
            easing: 'easeOutQuart'
        };
        
        // 解决Chart.js重复渲染问题
        Chart.register({
            id: 'resetPlugin',
            beforeInit: function(chart) {
                if (chart.canvas) {
                    console.log(`Chart.js初始化: ${chart.canvas.id}`);
                }
            }
        });
        
        // 全局图表实例管理
        const chartInstances = {};
        
        // 全局图表清理函数
        function resetChart(chartId) {
            try {
                if (chartInstances[chartId]) {
                    console.log(`清理已存储的图表实例: ${chartId}`);
                    chartInstances[chartId].destroy();
                    delete chartInstances[chartId];
                    return true;
                }
                
                const canvas = document.getElementById(chartId);
                if (canvas) {
                    const existingChart = Chart.getChart(canvas);
                    if (existingChart) {
                        console.log(`清理未存储的图表实例: ${chartId}`);
                        existingChart.destroy();
                        return true;
                    }
                }
            } catch (error) {
                console.error(`重置图表 ${chartId} 时出错:`, error);
            }
            return false;
        }
        
        // 创建Vue应用
        const app = Vue.createApp({
            data() {
                return {
                    // API基础URL
                    apiBaseUrl: 'http://localhost:8000',
                    
                    // 页面视图控制
                    activeTab: 'elasticity',
                    
                    // 图表实例存储
                    charts: {
                        elasticity: null,
                        gametheory: null,
                        dynamicDP: null,
                        dashboardRevenueChart: null,
                        dashboardUtilizationChart: null,
                        priceOptimizationChart: null,
                        computationSpeedChart: null,
                        marketSensitivityChart: null, 
                        predictionAccuracyChart: null,
                        adaptabilityChart: null,
                        profitabilityDriversChart: null,
                        scenarioAnalysisChart: null,
                        riskAssessmentChart: null,
                        competitiveLandscapeChart: null,
                        demandForecastChart: null
                    },
                    
                    // 新增：综合最优价格仪表盘数据
                    bestPriceDashboard: {
                        lastUpdated: null,
                        bookingPeriod: 14, // 固定为14天
                        isDataValid: false,
                        tableData: [], // [{ day: 1, cargoType: '快件', bestPrice: 10.5, source: '弹性' }, ...]
                        chartData: null, // 用于Chart.js的数据
                        message: '请选择航线和机型，加载推荐价格。', // 修改默认消息
                        selectedDayPrices: null, // 新增：存储选定日期的价格
                        dailyPricesByDay: {} // Added dailyPricesByDay property
                    },
                    
                    // 新增：仪表盘交互配置
                    dashboardConfig: {
                        selectedRouteIndex: 0, // Default to the first route
                        selectedAircraftType: null, // Will be set from localStorage or default
                        selectedDate: '', // Will be set to todayDate
                        bookingStartDate: '', // Added bookingStartDate
                        bookingEndDate: '', // Added bookingEndDate
                    },
                    dashboardLoading: false, // 控制仪表板加载状态
                    isFetchingDashboardPrices: false, // 新增：防止重复获取仪表盘价格
                    
                    selectedModel: null,
                    showModelSettings: true,
                    modelResults: {
                        show: false,
                        elasticity: null,
                        gametheory: null,
                        dynamicDP: null
                    },
                    elasticity: {
                        numAirlines: 1,
                        numSegments: 2,
                        cargoTypes: {
                            express: true,
                            fresh: true,
                            regular: true
                        },
                        priceElasticity: {
                            express: -1.7,
                            fresh: -1.2,
                            regular: -1.5
                        },
                        initialPrices: {
                            express: 12,
                            fresh: 7,
                            regular: 6
                        },
                        // 修改: 固定预订期
                        bookingPeriod: 14,
                        // 移除: bookingStartDate, bookingEndDate (不再用户配置)
                        aircraftType: 'A320', // 设置默认机型为 A320
                    },
                    gametheory: {
                        timePeriods: 14, // <-- 修改默认值为 14
                        kValue: 2.0,    // 根据论文设置为 2.0
                        companies: [
                            {
                                name: '公司1',
                                initial_capacity: 16713, // 更正: capacity -> initial_capacity
                                initialPrice: 5.8
                            },
                            {
                                name: '公司2',
                                initial_capacity: 13928, // 更正: capacity -> initial_capacity
                                initialPrice: 7.0
                            }
                        ],
                        aircraftType: null // 初始化为 null
                    },
                    dynamicDP: {
                        // 移除: bookingStartDate (不再用户配置)
                        bookingPeriod: 14, // 修改: 固定预订期
                        timePeriods: 350,
                        capacityWeight: 15000,
                        capacityVolume: 90000000,
                        gamma: 6000,
                        C_D_ratio: 0.9
                    },
                    activeView: 'dashboard',
                    elasticityView: 'config',
                    gametheoryView: 'config',
                    dynamicDPView: 'config',
                    currentDate: new Date().toLocaleDateString(),
                    dashboardData: {
                        elasticity: {
                            express: 10,
                            fresh: 8,
                            regular: 6
                        },
                        gametheory: {
                            company1: 5.8,
                            company2: 7.0,
                            currentStage: 11
                        },
                        dynamicDP: {
                            express: 10.5,
                            fresh: 7.2,
                            regular: 5.8
                        }
                    },
                    showSettings: {
                        elasticity: true,
                        gametheory: true,
                        dynamicDP: true
                    },
                    // 航线信息
                    routeInfo: null,    // Stores the full selected route object
                    
                    // 机型信息
                    aircraftInfo: null, // Stores the full selected aircraft object
                    
                    // 航线选择器选项 - 修改: 初始化为空数组
                    routeOptions: [],
                    
                    // 机型选择器选项 - 修改: 初始化为空数组
                    aircraftOptions: [],
                    showPriceChangeDetail: false,
                    // 新增: 存储今天的日期字符串
                    todayDate: new Date().toISOString().split('T')[0], 
                    expectedCargoTypesCount: 3, // Added expectedCargoTypesCount
                    
                    // 新增: 标准化货物类型键
                    bookingTypes: ['express', 'fresh', 'regular'], 

                    // 新增: API货物类型名称到标准键的映射
                    cargoTypeMapping: {
                        elasticity: {
                            "快件": "express", 
                            "鲜活": "fresh",
                            "普货": "regular" 
                        },
                        dynamicDP: {
                            "小型快件": "express",
                            "中型鲜活": "fresh",
                            "大型普货": "regular"
                        }
                    },

                    // 新增: 货物类型配置 (占位符，应包含显示名称和其他必要映射)
                    cargoConfig: {
                        express: { name: '快件', color: 'rgba(54, 162, 235, 1)', bgColor: 'rgba(54, 162, 235, 0.2)' }, 
                        fresh:   { name: '鲜活', color: 'rgba(255, 99, 132, 1)', bgColor: 'rgba(255, 99, 132, 0.2)' },
                        regular: { name: '普货', color: 'rgba(75, 192, 192, 1)', bgColor: 'rgba(75, 192, 192, 0.2)' }
                    },
                }
            },
            computed: {
                 // 新增: 计算属性显示固定预订期
                bookingPeriodDisplay() {
                    return 14;
                },
                // 新增: 计算属性显示当前预订期文本 (保持，虽然UI上移除了，但逻辑可能有用)
                currentBookingRangeText() {
                    if (this.dashboardConfig.currentBookingStart && this.dashboardConfig.currentBookingEnd) {
                        const start = new Date(this.dashboardConfig.currentBookingStart);
                        const end = new Date(this.dashboardConfig.currentBookingEnd);
                        // 简易格式化，可根据需要调整
                        const startMonth = start.getMonth() + 1;
                        const startDay = start.getDate();
                        const endMonth = end.getMonth() + 1;
                        const endDay = end.getDate();
                        return `${startMonth}月${startDay}日 - ${endMonth}月${endDay}日`;
                    }
                    return '计算中...';
                },
                elasticityRevenueIncreaseDisplay() {
                    if (!this.modelResults.elasticity || 
                        this.modelResults.elasticity.initial_revenue === undefined || 
                        this.modelResults.elasticity.optimal_revenue === undefined) {
                        return 'N/A';
                    }

                    const initialRev = this.modelResults.elasticity.initial_revenue; // Already parsed in runElasticityModel
                    const optimalRev = this.modelResults.elasticity.optimal_revenue; // Already parsed
                    let increasePercent = this.modelResults.elasticity.revenue_increase_percent; // Parsed from API's result.revenue_increase

                    // Ensure that initialRev and optimalRev, after parsing, are not NaN
                    if (isNaN(initialRev) || isNaN(optimalRev)) {
                        return 'N/A';
                    }

                    if (initialRev === 0) {
                        if (optimalRev > 0) return '+∞%';
                        if (optimalRev === 0) return '0.0%';
                        // Case for optimalRev < 0 when initialRev is 0 (e.g. loss from zero)
                        return optimalRev < 0 ? '-∞%' : 'N/A'; 
                    }

                    // If increasePercent from API was NaN (e.g. API sent null for infinity, or was just missing/invalid)
                    // and initialRev is not zero, we must recalculate it.
                    if (isNaN(increasePercent)) {
                        // initialRev is confirmed not to be 0 at this point by the check above.
                        increasePercent = ((optimalRev - initialRev) / initialRev) * 100;
                    }
                    
                    // Now, increasePercent should be a valid number (either from API or recalculated).
                    // If it's still NaN (e.g., if optimalRev or initialRev were such that calculation yields NaN, though unlikely with prior checks),
                    // then display N/A.
                    if (isNaN(increasePercent)) {
                        return 'N/A'; 
                    }

                    const sign = increasePercent >= 0 ? '+' : '';
                    return sign + increasePercent.toFixed(1) + '%';
                },

                elasticityRevenueIsPositive() {
                    if (!this.modelResults.elasticity || 
                        this.modelResults.elasticity.revenue_increase_percent === undefined || 
                        isNaN(this.modelResults.elasticity.revenue_increase_percent)) {
                        return null; 
                    }
                    // Ensure initial revenue is not zero before evaluating positivity based on percentage
                    const initialRev = this.modelResults.elasticity.initial_revenue;
                     if (typeof initialRev === 'number' && !isNaN(initialRev) && initialRev === 0) {
                        const optimalRev = this.modelResults.elasticity.optimal_revenue;
                        return typeof optimalRev === 'number' && !isNaN(optimalRev) && optimalRev > 0;
                    }
                    return this.modelResults.elasticity.revenue_increase_percent > 0;
                },

                elasticityRevenueIsNegative() {
                    if (!this.modelResults.elasticity || 
                        this.modelResults.elasticity.revenue_increase_percent === undefined || 
                        isNaN(this.modelResults.elasticity.revenue_increase_percent)) {
                        return false;
                    }
                     const initialRev = this.modelResults.elasticity.initial_revenue;
                     if (typeof initialRev === 'number' && !isNaN(initialRev) && initialRev === 0) {
                        return false; // Cannot be negative if starting from 0
                    }
                    return this.modelResults.elasticity.revenue_increase_percent < 0;
                }

            },
            watch: {
                'dashboardConfig.selectedRouteIndex': function(newVal, oldVal) {
                    if (newVal !== oldVal && newVal >= 0 && newVal < this.routeOptions.length) {
                        const selectedRoute = this.routeOptions[newVal];
                        console.log("仪表盘航线选择变更:", selectedRoute.origin, "->", selectedRoute.destination);
                        this.routeInfo = { ...selectedRoute };
                        this.updateModelParametersForRoute(newVal); // 更新模型参数
                        this.handleRouteOrAircraftChange(); // 然后触发价格获取
                    }
                },
                'dashboardConfig.selectedAircraftType': function(newVal, oldVal) {
                     if (newVal !== oldVal && newVal) { // Ensure newVal is not null/undefined
                        console.log("仪表盘机型选择变更:", newVal);
                        const selectedAircraftData = this.aircraftOptions.find(a => a.type === newVal);
                        if (selectedAircraftData) {
                            this.aircraftInfo = { ...selectedAircraftData };
                             this.updateModelParametersForAircraft(newVal); // 更新模型参数
                            // this.updateModelsWithAircraftData(); // Make sure this is the correct function or integrate its logic
                        } else {
                            console.warn(`Watcher: 未找到机型 ${newVal} 的数据。`);
                        }
                        this.handleRouteOrAircraftChange(); // 然后触发价格获取
                    } else if (newVal === null || typeof newVal === 'undefined') {
                        console.log("仪表盘机型选择变更为无效值:", newVal);
                        this.aircraftInfo = null; // Clear aircraftInfo if type becomes invalid
                    }
                },
                // 移除: 对 daysUntilDeparture 的 watch
                // 'dashboardConfig.daysUntilDeparture': function(newVal, oldVal) { ... },
                 // 新增：监控选定日期的变化
                'dashboardConfig.selectedDate': function(newVal, oldVal) {
                    if (newVal === oldVal) return; // No change

                    const today = this.getFormattedDate(new Date()); // Ensure todayDate is fresh

                    if (newVal && newVal >= today) {
                        console.log("Watcher dashboardConfig.selectedDate (valid):", newVal);
                        // THIS IS THE KEY: Recalculate booking period (which sets bookingStartDate to cycle start)
                        this.calculateCurrentBookingPeriod(); 
                        this.checkAndDisplayDashboardBestPrice(); 
                    } else {
                        let newSelectedDateToTry = today; // Default to today if newVal is invalid
                        const originalInvalidDate = newVal;

                        console.warn(`Watcher dashboardConfig.selectedDate: Invalid date ${originalInvalidDate}. Attempting reset to ${newSelectedDateToTry}.`);
                         this.bestPriceDashboard.isDataValid = false;
                         this.bestPriceDashboard.selectedDayPrices = null;
                        // dashboardConfig.bookingStartDate will be cleared/recalculated by calculateCurrentBookingPeriod

                        // Attempt to reset selectedDate to a valid one (e.g., today)
                        // This will trigger the watcher again. Avoid infinite loops.
                        if (this.dashboardConfig.selectedDate !== newSelectedDateToTry) {
                            this.dashboardConfig.selectedDate = newSelectedDateToTry; // This will re-trigger the watcher
                            // Message will be set by the subsequent watcher run if still problematic, or by success
                        } else {
                            // If it's already today and somehow still failing (e.g. watcher logic error),
                            // or if newSelectedDateToTry was also invalid (not possible with 'today' usually)
                            // ensure period is set for the (already) 'today' date and attempt display.
                            this.bestPriceDashboard.message = `选择的日期 ${originalInvalidDate} 无效。请选择今天或将来的有效日期。当前日期: ${this.dashboardConfig.selectedDate}`;
                            this.calculateCurrentBookingPeriod(); 
                            this.checkAndDisplayDashboardBestPrice();
                        }
                    }
                },
                // 移除: 对 bookingStartDate, bookingEndDate 的 watch
                // 'dashboardConfig.bookingStartDate': function(newVal, oldVal) { ... },
                // 'dashboardConfig.bookingEndDate': function(newVal, oldVal) { ... }
            },
            methods: {
                 // 新增：格式化日期为 YYYY-MM-DD
                formatDate(date) {
                    const year = date.getFullYear();
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const day = date.getDate().toString().padStart(2, '0');
                    return `${year}-${month}-${day}`;
                },
                // 新增：计算当前有效预订期
                calculateCurrentBookingPeriod() {
                    // The baseDateForPeriod is the user's selected date, or today if not set
                    const baseDateForPeriod = this.dashboardConfig.selectedDate || this.getFormattedDate(new Date());
                    
                    // Calculate the START of the 14-day cycle this baseDateForPeriod falls into
                    const cycleStartDate = this.getCycleStartDate(baseDateForPeriod);
                    this.dashboardConfig.currentBookingStart = cycleStartDate;
                    
                    // Set the dashboard's bookingStartDate to this cycle start. This is CRUCIAL.
                    this.dashboardConfig.bookingStartDate = cycleStartDate; 

                    const endDate = new Date(cycleStartDate + 'T00:00:00'); // Ensure parsing as local time start of day
                    endDate.setDate(endDate.getDate() + 13); // 14 days total
                    this.dashboardConfig.currentBookingEnd = this.getFormattedDate(endDate);
                    
                    console.log(`Calculated Booking Period (Cycle Start): ${this.dashboardConfig.currentBookingStart} to ${this.dashboardConfig.currentBookingEnd}. User selected: ${baseDateForPeriod}. Effective bookingStartDate for models/display: ${this.dashboardConfig.bookingStartDate}`);
                },
                // 新增：获取基于5月1日的14天周期开始日期
                getCycleStartDate(selectedDateStr) {
                    if (!selectedDateStr) {
                        selectedDateStr = this.getFormattedDate(new Date()); // Default to today if not provided
                    }
                    const targetDate = new Date(selectedDateStr + 'T00:00:00'); // Use T00:00:00 to ensure local date interpretation
                    if (isNaN(targetDate.getTime())) {
                        console.error("getCycleStartDate: Invalid selectedDateStr provided:", selectedDateStr, "defaulting to today.");
                        targetDate.setTime(new Date(this.getFormattedDate(new Date()) + 'T00:00:00').getTime());
                    }
                    const year = targetDate.getFullYear();
                    
                    // Anchor is May 1st of the targetDate's year, or previous year if targetDate is before May 1st of its year.
                    let anchorMay1st = new Date(year, 4, 1, 0, 0, 0, 0); // May is month 4. Explicitly set time to 00:00:00.000
                    if (targetDate < anchorMay1st) {
                        anchorMay1st = new Date(year - 1, 4, 1, 0, 0, 0, 0); 
                    }

                    // Calculate difference in days from this anchorMay1st
                    // Ensure both dates are treated as start-of-day for consistent diff calculation
                    const targetDateStartOfDay = new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate());
                    const anchorMay1stStartOfDay = new Date(anchorMay1st.getFullYear(), anchorMay1st.getMonth(), anchorMay1st.getDate());

                    const diffInMs = targetDateStartOfDay.getTime() - anchorMay1stStartOfDay.getTime();
                    const diffInDays = Math.floor(diffInMs / (1000 * 60 * 60 * 24));

                    // Determine the cycle index and the start date of that cycle
                    const periodIndex = Math.floor(diffInDays / 14);
                    const cycleStartDate = new Date(anchorMay1stStartOfDay.getTime());
                    cycleStartDate.setDate(anchorMay1stStartOfDay.getDate() + periodIndex * 14);
                    
                    console.log(`getCycleStartDate: target=${selectedDateStr}, anchorMay1st=${this.getFormattedDate(anchorMay1st)}, diffInDays=${diffInDays}, periodIndex=${periodIndex}, cycleStart=${this.getFormattedDate(cycleStartDate)}`);
                    return this.getFormattedDate(cycleStartDate);
                },
                // 新增：计算选定日期是预订期的第几天 (从1开始)
                calculateDaysUntilDeparture(selectedDateStr, bookingStartDateStr) {
                    if (!selectedDateStr || !bookingStartDateStr) {
                        return 1; // 默认返回第一天
                    }
                    try {
                        // 使用 Date 对象进行计算，确保兼容性
                        const selectedDate = new Date(selectedDateStr + 'T00:00:00'); // 明确指定时间避免时区问题
                        const bookingStartDate = new Date(bookingStartDateStr + 'T00:00:00');

                        if (isNaN(selectedDate.getTime()) || isNaN(bookingStartDate.getTime())) {
                            console.error("无效的日期字符串:", selectedDateStr, bookingStartDateStr);
                            return 1;
                        }

                        // 计算毫秒差
                        const diffInMs = selectedDate.getTime() - bookingStartDate.getTime();
                        
                        // 转换为天数 (考虑+1，因为第一天是第1天)
                        const diffInDays = Math.round(diffInMs / (1000 * 60 * 60 * 24));
                        const dayIndex = diffInDays + 1;

                        // 确保结果在 1 到 14 之间
                        return Math.max(1, Math.min(dayIndex, 14)); 
                    } catch (error) {
                        console.error("计算天数差异时出错:", error);
                        return 1; // 出错时返回第一天
                    }
                },
                selectModel(model) {
                    this.selectedModel = model;
                    this.showModelSettings = true;
                    // 重置结果
                    this.modelResults.show = false;
                },
                toggleModelSettings(model) {
                    this.showModelSettings = !this.showModelSettings;
                },
                resetModelParams(model) {
                    if (model === 'elasticity') {
                        this.elasticity = {
                            numAirlines: 1,
                            numSegments: 2,
                            cargoTypes: {
                                express: true,
                                fresh: true,
                                regular: true
                            },
                            priceElasticity: {
                                express: -1.7,
                                fresh: -1.2,
                                regular: -1.5
                            },
                            initialPrices: {
                                express: 12,
                                fresh: 7,
                                regular: 6
                            },
                            bookingPeriod: 14, // 固定
                            aircraftType: this.aircraftInfo.type // 保留机型
                        };
                    } else if (model === 'gametheory') {
                        this.gametheory = {
                            timePeriods: 14, // <-- 修改默认值为 14
                            kValue: 2.0,    // 根据论文设置为 2.0
                            companies: [
                                {
                                    name: '公司1',
                                    initial_capacity: 16713, // 更正: capacity -> initial_capacity
                                    initialPrice: 5.8
                                },
                                {
                                    name: '公司2',
                                    initial_capacity: 13928, // 更正: capacity -> initial_capacity
                                    initialPrice: 7.0
                                }
                            ],
                            aircraftType: this.aircraftInfo.type // 保留机型
                        };
                         // 重置后重新计算容量
                        this.updateModelsWithAircraftData();
                    } else if (model === 'dynamicDP') {
                        this.dynamicDP = {
                            bookingPeriod: 14, // 固定
                            timePeriods: 350,
                            capacityWeight: this.aircraftInfo.max_payload, // 保留机型相关
                            capacityVolume: this.aircraftInfo.max_volume, // 保留机型相关
                            gamma: 6000,
                            C_D_ratio: 0.9
                        };
                    }
                },
                runModel(model) {
                    // 模拟模型运行，生成结果
                    this.modelResults.show = true;
                    
                    if (model === 'elasticity') {
                        this.runElasticityModel();
                    } else if (model === 'gametheory') {
                        this.runGameTheoryModel();
                    } else if (model === 'dynamicDP') {
                        this.runDynamicProgrammingModel();
                    }
                },
                // 运行弹性模型
                runElasticityModel() {
                    console.log("开始运行弹性定价模型");
                    
                    // 显示加载状态
                    this.elasticityLoading = true;
                    
                    // 构建请求数据
                    const requestData = {
                        // 航线信息
                        origin: this.routeInfo.origin,
                        destination: this.routeInfo.destination,
                        distance: this.routeInfo.distance,
                        competition_level: this.routeInfo.competition_level,
                        popularity: this.routeInfo.popularity,
                        season_factor: this.routeInfo.season_factor,
                        flight_type: this.routeInfo.flight_type,
                        
                        // 机型信息
                        aircraft_type: this.aircraftInfo.type,
                        max_payload: this.aircraftInfo.max_payload,
                        max_volume: this.aircraftInfo.max_volume,
                        
                        // 弹性模型特定参数
                        initial_price: this.elasticity.initialPrice, // 注意：这个属性可能已不存在或未使用
                        price_elasticity: this.elasticity.priceElasticity,
                        // 移除: min_price, max_price (如果未使用)
                        booking_period: this.elasticity.bookingPeriod // 传递固定值 14
                    };
                    
                    // 调用API计算弹性定价
                    this.calculateElasticityPricing(requestData);
                },
                
                // 运行博弈论模型
                async runGameTheoryModel() {
                    console.log('[Debug GT] Entering runGameTheoryModel. this:', this);
                    // Simplified logging to avoid potential stringify side-effects
                    console.log('[Debug GT] Raw this.isLoading at entry:', this.isLoading);
                    console.log('[Debug GT] Raw this.modelResults at entry:', this.modelResults);
                    if (this.isLoading) {
                        console.log('[Debug GT] this.isLoading.gametheory at entry:', this.isLoading.gametheory);
                    }
                    if (this.modelResults) {
                        console.log('[Debug GT] this.modelResults.gametheory at entry:', this.modelResults.gametheory);
                    }

                    // Defensive initialization / Band-aid
                    if (typeof this.isLoading === 'undefined' || this.isLoading === null) {
                        console.warn('[Debug GT] this.isLoading was undefined/null. Re-initializing.');
                        this.isLoading = { 
                            elasticity: false, 
                            gametheory: false, 
                            dynamicDP: false, 
                            dashboard: false, 
                            routes: false, 
                            aircrafts: false 
                        };
                    }
                    if (typeof this.modelResults === 'undefined' || this.modelResults === null) {
                        console.warn('[Debug GT] this.modelResults was undefined/null. Re-initializing.');
                        this.modelResults = { 
                            elasticity: null, 
                            gametheory: null, 
                            dynamicDP: null, 
                            dashboardElasticity: null, 
                            dashboardDynamicDP: null, 
                            dashboardGameTheory: null,
                            lastRunParams: {} // Ensure this exists if it's used elsewhere
                        };
                    }
                    
                    // Ensure the specific sub-properties exist if the main objects might have been incomplete
                    if (this.isLoading && !this.isLoading.hasOwnProperty('gametheory')) {
                        console.warn('[Debug GT] this.isLoading.gametheory was missing. Initializing to false.');
                        this.isLoading.gametheory = false;
                    }
                    if (this.modelResults && !this.modelResults.hasOwnProperty('gametheory')) {
                        console.warn('[Debug GT] this.modelResults.gametheory was missing. Initializing to null.');
                        this.modelResults.gametheory = null;
                    }

                    try {
                        console.log("开始执行博弈论模型...");
                        this.isLoading.gametheory = true;

                        // 1. 获取并校验公司数据
                        const companies = this.gametheory.companies;
                        if (!companies || !Array.isArray(companies) || companies.length !== 2) {
                            console.error("博弈论模型错误: 公司数据无效或不完整。需要两家公司的数据。");
                            this.modelResults.gametheory = {
                                error: true,
                                message: "公司数据无效或不完整。请在上方配置两家公司的信息。"
                            };
                            this.isLoading.gametheory = false;
                            return;
                        }
                        // 可选：更详细地校验每家公司的数据结构，例如是否有 initial_capacity, initialPrice
                        for(let i=0; i < companies.length; i++) {
                            if (companies[i].initial_capacity === undefined || companies[i].initialPrice === undefined || companies[i].name === undefined) {
                                 console.error(`博弈论模型错误: 公司 ${i+1} 数据不完整 (缺少名称、初始容量或初始价格)。`);
                                 this.modelResults.gametheory = {
                                    error: true,
                                    message: `公司 ${i+1} (${companies[i].name || '未命名'}) 数据不完整。请检查其初始容量和初始价格设置。`
                                };
                                this.isLoading.gametheory = false;
                                return;
                            }
                        }

                        // 2. 构建请求数据
                        const modelSpecificParams = this.getModelSpecificParams('gametheory');
                        const requestData = {
                            ...this.routeInfo, // 包含 origin, destination, distance 等
                            aircraft_type: this.aircraftInfo ? this.aircraftInfo.type : null,
                            // 机型参数应从 aircraftInfo 获取，而不是依赖 routeInfo 中的旧数据
                            max_payload: this.aircraftInfo ? this.aircraftInfo.max_payload : null,
                            max_volume: this.aircraftInfo ? this.aircraftInfo.max_volume : null,
                            
                            // 从博弈论模型参数区域获取的参数，如k_value, time_periods (如果这些是在全局设置的)
                            // 注意：getModelSpecificParams('gametheory') 可能会返回 k_value 和 time_periods
                            // 这些应该是模型级别的默认值或覆盖值。
                            // 后端API现在会优先处理请求体中的这些顶级参数，然后是模型内部的数据库/默认值。
                            // 公司特定的参数（如初始价格、容量）会通过 companies 数组传递。
                            k_value: modelSpecificParams.k_value, // API会处理此 vs DB
                            time_periods: modelSpecificParams.time_periods, // API会处理此 vs DB
                            demand_base_factor: modelSpecificParams.demand_base_factor,
                            price_sensitivity_factor: modelSpecificParams.price_sensitivity_factor,
                            cross_price_sensitivity_factor: modelSpecificParams.cross_price_sensitivity_factor,
                            cost_base_factor: modelSpecificParams.cost_base_factor,
                            cost_variable_factor: modelSpecificParams.cost_variable_factor,
                            
                            companies: companies.map(comp => ({
                                id: comp.id || comp.name, // API 现在可以处理 name 作为 id 的回退
                                name: comp.name,
                                initial_capacity: parseFloat(comp.initial_capacity),
                                initialPrice: parseFloat(comp.initialPrice),
                                // 注意: 公司特定的 k_value 和 time_periods (如果之前有这样的设计) 
                                // 现在不由前端传递。模型使用全局的 k_value 和 T_periods，
                                // 或通过 route_id 从数据库加载。
                                // 如果AirCargoCompetitiveModel的构造函数需要它们，它会从API传入的顶级k_value/T_periods获取，
                                // 或者从其内部的 _initialize_model_specific_params 方法通过route_id加载
                            }))
                        };
                        
                        console.log("发送博弈论模型请求数据:", JSON.stringify(requestData, null, 2));
                        
                        const response = await fetch(`${this.apiBaseUrl}/api/gametheory/calculate`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestData)
                        });
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error("博弈论API错误响应: ", errorText);
                            let errorMsg = `网络响应错误: ${response.status} ${response.statusText}`;
                            try {
                                const errorJson = JSON.parse(errorText);
                                if (errorJson && errorJson.error) {
                                    errorMsg = errorJson.error; 
                                }
                            } catch (e) { /* Ignore parsing error, use original errorText */ }
                            this.modelResults.gametheory = { error: true, message: errorMsg };
                            throw new Error(errorMsg); // Propagate for UI update
                        }
                        
                        const result = await response.json();
                        console.log("博弈论模型API响应:", JSON.stringify(result, null, 2));
                        
                        if (result.status === 'success') {
                            const c1Data = result.results.company1;
                            const c2Data = result.results.company2;
                            
                            let priceTableForChart = [];
                            if (c1Data && c1Data.prices && c1Data.revenues && Array.isArray(c1Data.prices) && Array.isArray(c1Data.revenues) &&
                                c2Data && c2Data.prices && c2Data.revenues && Array.isArray(c2Data.prices) && Array.isArray(c2Data.revenues) &&
                                c1Data.prices.length === c2Data.prices.length &&
                                c1Data.revenues.length === c1Data.prices.length &&
                                c2Data.revenues.length === c2Data.prices.length) {
                                for (let i = 0; i < c1Data.prices.length; i++) {
                                    priceTableForChart.push({
                                        period: i + 1,
                                        price1: Number(c1Data.prices[i]),
                                        price2: Number(c2Data.prices[i]),
                                        revenue1: Number(c1Data.revenues[i]),
                                        revenue2: Number(c2Data.revenues[i])
                                    });
                                }
                            } else {
                                console.error("博弈论模型的公司价格或收益数据不匹配或缺失。");
                            }

                            this.modelResults.gametheory = {
                                ...result,
                                priceTable: priceTableForChart,
                                companiesForChart: [
                                    { name: c1Data ? c1Data.name : '公司1', totalRevenue: c1Data ? parseFloat(c1Data.total_revenue) : 0 },
                                    { name: c2Data ? c2Data.name : '公司2', totalRevenue: c2Data ? parseFloat(c2Data.total_revenue) : 0 }
                                ]
                            };
                            this.gametheoryView = 'results';
                            this.$nextTick(() => { // Ensure DOM is updated before rendering chart
                                this.renderGameTheoryChart();
                            });
                        } else {
                            console.error("博弈论模型计算失败:", result.message || result.error);
                            this.modelResults.gametheory = { error: true, message: result.message || result.error || "计算失败" };
                        }
                    } catch (error) {
                        console.error('调用博弈论模型API或处理响应时出错:', error);
                        if (!this.modelResults.gametheory || !this.modelResults.gametheory.message) {
                             this.modelResults.gametheory = { error: true, message: '客户端错误: ' + error.message };
                        }
                    } finally {
                        this.isLoading.gametheory = false;
                    }
                },
                
                // 运行动态规划模型
                runDynamicProgrammingModel() {
                    console.log("开始运行动态规划模型");
                    
                    // 显示加载状态
                    this.dynamicDPLoading = true;
                    
                    // 构建请求数据
                    const requestData = {
                        // 航线信息
                        origin: this.routeInfo.origin,
                        destination: this.routeInfo.destination,
                        distance: this.routeInfo.distance,
                        competition_level: this.routeInfo.competition_level,
                        popularity: this.routeInfo.popularity,
                        season_factor: this.routeInfo.season_factor,
                        flight_type: this.routeInfo.flight_type,
                        
                        // 机型信息
                        aircraft_type: this.aircraftInfo.type,
                        max_payload: this.aircraftInfo.max_payload,
                        max_volume: this.aircraftInfo.max_volume,
                        
                        // 动态规划特定参数
                        booking_period: this.dynamicDP.bookingPeriod, // 传递固定值 14
                        gamma: this.dynamicDP.gamma,
                        C_D_ratio: this.dynamicDP.C_D_ratio
                    };
                    
                    // 调用API计算动态规划定价
                    this.calculateDynamicProgrammingPricing(requestData);
                },
                async runElasticityModel() {
                    try {
                        console.log("开始执行需求弹性模型...");
                        this.elasticityLoading = true; // 开始加载
                        
                        const requestData = {
                            route_id: this.routeInfo ? this.routeInfo.id : null, // Pass route_id
                            // Fallback to individual route/aircraft params if route_id isn't primary yet
                            ...(this.routeInfo && !this.routeInfo.id && { // only spread if no id
                                origin: this.routeInfo.origin,
                                destination: this.routeInfo.destination,
                                distance: this.routeInfo.distance,
                                competition_level: this.routeInfo.competition_level,
                                popularity: this.routeInfo.popularity,
                                season_factor: this.routeInfo.season_factor,
                                flight_type: this.routeInfo.flight_type,
                            }),
                            ...(this.aircraftInfo && { // always spread aircraft info if available
                            aircraft_type: this.aircraftInfo.type,
                            max_payload: this.aircraftInfo.max_payload,
                            max_volume: this.aircraftInfo.max_volume,
                            }),
                            ...this.getModelSpecificParams('elasticity') // Get elasticity specific params like initial_prices, price_elasticity etc.
                        };
                        
                        console.log("发送弹性模型请求数据 (详细):", JSON.stringify(requestData, null, 2));
                        
                        const response = await fetch(`${this.apiBaseUrl}/api/elasticity/calculate`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestData)
                        });
                        
                        if (!response.ok) {
                            const errorBody = await response.text();
                            console.error("弹性模型 API 错误响应体:", errorBody);
                            throw new Error(`网络响应错误: ${response.status} ${response.statusText}`);
                        }
                        
                        const result = await response.json(); // result directly contains the new structure
                        console.log("弹性模型API响应 (新结构):", JSON.stringify(result, null, 2));
                        
                        if (result.status === 'success') {
                            // The API now returns price_table, initial_revenue, optimal_revenue, revenue_increase,
                            // optimal_prices_per_unit_array, daily_prices_list, raw_demand_details.

                            // Transform daily_prices_list for the chart
                            const parsed_daily_prices_for_chart = {};
                            if (result.daily_prices_list && Array.isArray(result.daily_prices_list)) {
                                result.daily_prices_list.forEach(item => {
                                    const englishKey = this.cargoTypeMapping.elasticity[item.cargoType]; // "快件" -> "express"
                                    if (englishKey && item.dailyPrices && Array.isArray(item.dailyPrices)) {
                                        parsed_daily_prices_for_chart[englishKey] = item.dailyPrices.map(dp => dp.price);
                                    }
                                });
                            }
                            console.log("转换后的 parsed_daily_prices_for_chart:", JSON.parse(JSON.stringify(parsed_daily_prices_for_chart)));

                            this.modelResults.elasticity = {
                                ...result, // Store all API results
                                parsed_daily_prices_for_chart: parsed_daily_prices_for_chart // Add the transformed chart data
                            };
                            
                            this.elasticityView = 'results';
                            this.checkAndDisplayDashboardBestPrice(); 
                        } else {
                            console.error("弹性模型计算失败:", result.message);
                            alert('弹性模型计算失败: ' + result.message);
                        }
                    } catch (error) {
                        console.error('调用弹性模型API失败:', error);
                        alert('调用弹性模型API失败: ' + error.message);
                    } finally {
                        this.elasticityLoading = false; 
                    }
                },
                async runDynamicProgrammingModel() {
                    try {
                        console.log("开始执行动态规划模型...");
                        this.dynamicDPLoading = true; // 开始加载
                        
                        const requestData = {
                            ...this.routeInfo,
                            aircraft_type: this.aircraftInfo.type,
                            max_payload: this.aircraftInfo.max_payload,
                            max_volume: this.aircraftInfo.max_volume,
                            ...this.getModelSpecificParams() // 获取DP参数, 包括 booking_period: 14
                        };
                        
                         // --- 新增: 详细打印请求数据 ---
                        console.log("发送动态规划模型请求数据 (详细):", JSON.stringify(requestData, null, 2));
                        // --- 修改: 修正日志打印，只打印一次正确的 aircraftInfo ---
                        console.log("当前机型信息 (DP):", JSON.stringify(this.aircraftInfo, null, 2)); 
                        // --- 结束修改 ---
                        
                        const response = await fetch(`${this.apiBaseUrl}/api/dynamicdp/calculate`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestData)
                        });
                        
                        if (!response.ok) {
                             // --- 新增: 打印错误响应体 ---
                            const errorBody = await response.text();
                            console.error("动态规划 API 错误响应体:", errorBody);
                             // --- 结束新增 ---
                            throw new Error(`网络响应错误: ${response.status} ${response.statusText}`);
                        }
                        
                        const result = await response.json();
                        console.log("动态规划模型API响应:", JSON.stringify(result, null, 2));
                        
                        if (result.status === 'success') {
                            console.log("动态规划模型API成功响应:", JSON.stringify(result, null, 2));
                            
                            this.modelResults.dynamicDP = result;
                            this.dynamicDPView = 'results'; // 这会触发 v-if 条件

                            this.$nextTick(() => {
                                // 确保视图和数据都准备好
                                if (this.activeView === 'dynamicdp' && this.dynamicDPView === 'results' && this.modelResults.dynamicDP) {
                                this.renderDynamicProgrammingChart();
                                }
                            });
                            
                                // this.updateBestPriceDashboard(); // 不再直接调用
                                this.checkAndDisplayDashboardBestPrice(); // 检查并更新仪表盘
                        } else {
                            console.error("动态规划模型计算失败:", result.message);
                            alert('动态规划模型计算失败: ' + result.message); // 修改提示
                        }
                    } catch (error) {
                        console.error('调用动态规划模型API失败:', error);
                        alert('调用动态规划模型API失败: ' + error.message);
                    } finally {
                         this.dynamicDPLoading = false; // 结束加载
                    }
                },
                renderElasticityChart(data) {
                    try {
                        console.log("开始渲染弹性模型每日价格图表 (新)...");
                        
                        const resultsData = data || this.modelResults.elasticity;
                        const bookingPeriod = 14; 
                        console.log("渲染图表使用固定 bookingPeriod:", bookingPeriod);
                        
                        // --- MODIFIED: Use the new parsed_daily_prices_for_chart with English keys ---
                        const chartDataByEnglishKey = resultsData?.parsed_daily_prices_for_chart;

                        if (!resultsData || !chartDataByEnglishKey || Object.keys(chartDataByEnglishKey).length === 0) {
                            console.error(`弹性模型 parsed_daily_prices_for_chart 数据缺失或无效，无法渲染图表。`, chartDataByEnglishKey);
                            const chartCanvas = document.getElementById('elasticityChart');
                            if(chartCanvas) {
                                const ctx = chartCanvas.getContext('2d');
                                ctx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);
                                ctx.font = '16px Arial';
                                ctx.fillStyle = 'gray';
                                ctx.textAlign = 'center';
                                ctx.fillText('无每日价格数据可供显示', chartCanvas.width / 2, chartCanvas.height / 2);
                            }
                             if (this.charts.elasticity) {
                                this.charts.elasticity.destroy();
                                this.charts.elasticity = null;
                            }
                            return;
                        }
                        
                        const labels = Array.from({ length: bookingPeriod }, (_, i) => `第 ${i + 1} 天`); 
                        const datasets = [];

                        // Iterate using this.bookingTypes to control order and use English keys
                        this.bookingTypes.forEach(englishKey => { // e.g., 'express', 'fresh', 'regular'
                            if (chartDataByEnglishKey[englishKey] && Array.isArray(chartDataByEnglishKey[englishKey])) {
                                const prices = chartDataByEnglishKey[englishKey];
                                const cargoConfig = this.cargoConfig[englishKey] || { name: englishKey, color: 'gray', bgColor: 'lightgray' }; // Fallback config

                                if (prices.length === bookingPeriod) {
                                datasets.push({
                                        label: cargoConfig.name, // Use Chinese name for display from cargoConfig
                                    data: prices,
                                        borderColor: cargoConfig.color,
                                        backgroundColor: cargoConfig.bgColor,
                                    borderWidth: 2,
                                    tension: 0.1,
                                        fill: false
                                });
                            } else {
                                     console.warn(`货物类型 ${cargoConfig.name} 的每日价格数据长度 (${prices.length}) 与预订期 (${bookingPeriod}) 不符，跳过此类型。`);
                                }
                            } else {
                                console.warn(`货物类型 ${englishKey} 的每日价格数据无效或为空，跳过此类型。`);
                            }
                        });
                        
                        console.log("弹性模型图表数据集 (新):", JSON.stringify(datasets));
                        
                        let minPrice = Infinity;
                        let maxPrice = -Infinity;
                        datasets.forEach(dataset => {
                            dataset.data.forEach(price => {
                                if (price !== null && price < minPrice) minPrice = price;
                                if (price !== null && price > maxPrice) maxPrice = price;
                            });
                        });

                        const suggestedMin = minPrice !== Infinity ? Math.floor(minPrice * 0.9) : 0;
                        const suggestedMax = maxPrice !== -Infinity ? Math.ceil(maxPrice * 1.1) : 10;


                        if (this.charts.elasticity) {
                            this.charts.elasticity.destroy();
                        }
                        
                        const ctx = document.getElementById('elasticityChart').getContext('2d');
                        this.charts.elasticity = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                    datasets: datasets
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: false, 
                                        suggestedMin: suggestedMin > 0 ? suggestedMin : 0, 
                                        suggestedMax: suggestedMax
                                    }
                                },
                                plugins: {
                                         legend: {
                                            position: 'top',
                                    },
                                    title: {
                                        display: true,
                                        text: '每日价格弹性分析'
                                    }
                                }
                            }
                        });
                        console.log("弹性模型每日价格图表渲染完成 (新)。");
                    } catch (error) {
                        console.error("渲染弹性模型图表失败 (新):", error);
                    }
                },
                
                renderGameTheoryChart(data) {
                    try {
                        console.log("开始渲染博弈论图表...");
                        const resultsData = data || this.modelResults.gametheory;
                        if (!resultsData || !resultsData.priceTable) {
                            console.error("没有可用的博弈论结果数据");
                            return;
                        }
                        
                        // 图表数据准备
                        const labels = resultsData.priceTable.map((_, idx) => `阶段 ${idx + 1}`); // 修改标签
                        const price1Data = resultsData.priceTable.map(row => row.price1);
                        const price2Data = resultsData.priceTable.map(row => row.price2);
                        
                        console.log("博弈论图表数据:", {
                            labels,
                            price1Data,
                            price2Data
                        });
                        
                        // 销毁现有图表
                        if (this.charts.gametheory) {
                            this.charts.gametheory.destroy();
                            console.log("已销毁旧的博弈论图表");
                        }
                        
                        // 确保DOM已经更新，在下一个事件循环中进行渲染
                        this.$nextTick(() => {
                            this.createGameTheoryChart(labels, price1Data, price2Data);
                        });
                    } catch (error) {
                        console.error("渲染博弈论图表时出错:", error);
                    }
                },
                
                createGameTheoryChart(labels, price1Data, price2Data) {
                    // 获取canvas元素
                        const canvas = document.getElementById('gametheoryChart');
                        if (!canvas) {
                        console.error("找不到gametheoryChart元素，将在500ms后重试");
                        setTimeout(() => this.createGameTheoryChart(labels, price1Data, price2Data), 500);
                            return;
                        }
                        
                    // 确保canvas可见并有正确的尺寸
                    const container = canvas.parentElement;
                    if (container) {
                        if (container.clientWidth === 0 || container.clientHeight === 0) {
                            console.log("Canvas容器尺寸为0，可能隐藏了，设置默认高度");
                            canvas.style.height = '300px';
                            canvas.style.width = '100%';
                        }
                    }
                    
                    // 创建新图表
                    try {
                        const ctx = canvas.getContext('2d');
                        if (!ctx) {
                            console.error("无法获取canvas 2d上下文");
                            return;
                        }
                        
                        console.log("创建博弈论图表...");
                        this.charts.gametheory = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        label: '公司1价格',
                                        data: price1Data,
                                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                        borderColor: 'rgba(54, 162, 235, 1)',
                                        borderWidth: 2,
                                        tension: 0.1,
                                        fill: false
                                    },
                                    {
                                        label: '公司2价格',
                                        data: price2Data,
                                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                        borderColor: 'rgba(255, 99, 132, 1)',
                                        borderWidth: 2,
                                        tension: 0.1,
                                        fill: false
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                    title: {
                                        display: true,
                                            text: '价格 (元/千克)'
                                    }
                                },
                                    x: {
                                        title: {
                                            display: true,
                                            text: '阶段'
                                        }
                                    }
                                },
                                plugins: {
                                    title: {
                                        display: true,
                                        text: '博弈论模型价格变化趋势'
                                    },
                                    legend: {
                                        position: 'top',
                                        display: true
                                    },
                                    tooltip: {
                                        enabled: true
                                    }
                                }
                            }
                        });
                        
                        console.log("博弈论图表渲染完成");
                    } catch (error) {
                        console.error("创建博弈论图表时出错:", error);
                    }
                },
                
                // 添加updateResultsSummary方法
                updateResultsSummary(modelType, data) {
                    console.log(`更新${modelType}模型结果摘要`, data);
                    // 这个函数之前被调用但未实现
                    // 实际上，由于我们直接在视图中通过v-for等指令渲染数据，不需要额外的结果摘要更新
                    // 保留这个函数以兼容之前的代码调用，但不做实际操作
                },
                
                renderDynamicProgrammingChart() {
                    try {
                        console.log("开始渲染动态规划图表(每日价格版)...");

                        // 统一使用 this.charts 进行管理和销毁
                        if (this.charts.dynamicDP) {
                            console.log("销毁旧的 dynamicDP 图表实例 (来自 this.charts)");
                            this.charts.dynamicDP.destroy();
                            this.charts.dynamicDP = null;
                        }

                        const canvas = document.getElementById('dynamicDPChart');
                        if (!canvas) {
                            console.error("找不到dynamicDPChart元素");
                            return;
                        }
                        // resetChart('dynamicDPChart'); // 移除对旧 resetChart 的调用

                        // 检查并获取包含每日价格的数据
                        if (!this.modelResults.dynamicDP || !this.modelResults.dynamicDP.bookingDaysPriceTable || !Array.isArray(this.modelResults.dynamicDP.bookingDaysPriceTable) || this.modelResults.dynamicDP.bookingDaysPriceTable.length === 0) {
                            console.error("动态规划每日价格表(bookingDaysPriceTable)数据不存在或格式不正确");
                            // 可以考虑在这里显示一个提示信息给用户
                            return;
                        }

                        const dailyData = this.modelResults.dynamicDP.bookingDaysPriceTable;
                        console.log("准备绘制新动态规划图表(每日)，数据:", JSON.stringify(dailyData));

                        // 生成X轴标签 (天数)
                        // 修改: 固定为14天
                        const numDays = 14; 
                        const labels = Array.from({ length: numDays }, (_, i) => `第${i + 1}天`);

                        // 为每个预订类型创建数据系列
                        const datasets = dailyData.map((item, index) => {
                            const colors = [
                                { border: 'rgba(255, 99, 132, 1)', background: 'rgba(255, 99, 132, 0.1)' }, // 红 (小型快件)
                                { border: 'rgba(54, 162, 235, 1)', background: 'rgba(54, 162, 235, 0.1)' }, // 蓝 (中型鲜活)
                                { border: 'rgba(75, 192, 192, 1)', background: 'rgba(75, 192, 192, 0.1)' }  // 青 (大型普货)
                            ];
                            const color = colors[index % colors.length];
                            
                            // 修改: 确保价格数组长度为 14
                            let prices = [];
                            if (item.dailyPrices && Array.isArray(item.dailyPrices)) {
                                // --- 修改: DP模型返回对象数组，需取 price 属性 ---
                                prices = item.dailyPrices.map(dp => dp && typeof dp.price === 'number' ? dp.price : 0); // 提取每日价格数组, 增加健壮性
                                // --- 结束修改 ---
                                if (prices.length !== numDays) {
                                     console.warn(`DP模型返回的 ${item.bookingType} 价格数据长度 (${prices.length}) 与预订期 (${numDays}) 不符。将尝试填充或截断。`);
                                     if (prices.length > numDays) {
                                         prices = prices.slice(0, numDays);
                                     } else {
                                         const lastPrice = prices.length > 0 ? prices[prices.length - 1] : 0;
                                         prices = prices.concat(Array(numDays - prices.length).fill(lastPrice));
                                     }
                                }
                            } else {
                                console.warn(`DP模型未返回 ${item.bookingType} 的有效价格数据，将使用0填充。`);
                                prices = Array(numDays).fill(0);
                            }
                            

                            return {
                                label: item.bookingType || `类型 ${index+1}`, // 确保有标签
                                data: prices,
                                borderColor: color.border,
                                backgroundColor: color.background, // 如果需要填充背景色
                                borderWidth: 2,
                                tension: 0.1,
                                fill: false // 线条图通常不填充
                            };
                        });

                        console.log("动态规划图表(每日)datasets:", JSON.stringify(datasets));

                        const ctx = canvas.getContext('2d');
                        // 存储到 this.charts.dynamicDP
                        this.charts.dynamicDP = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels, // X轴是天数
                                datasets: datasets // 每个数据集是一条每日价格曲线
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    title: {
                                        display: true,
                                        text: '动态规划每日价格策略' // 修改标题
                                    },
                                    legend: {
                                        position: 'top',
                                    },
                                    tooltip: {
                                        mode: 'index',
                                        intersect: false,
                                        callbacks: {
                                            label: function(context) {
                                                // --- 修改: 添加检查 context.dataset.label ---
                                                const label = context.dataset.label || '';
                                                return label + ': ' + context.parsed.y.toFixed(2) + ' 元/kg';
                                                // --- 结束修改 ---
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        title: {
                                            display: true,
                                            text: '价格 (元/kg)'
                                        },
                                        beginAtZero: false // 价格通常不从0开始
                                    },
                                    x: {
                                        title: {
                                            display: true,
                                            text: '预订天数' // 修改X轴标题
                                        }
                                    }
                                }
                            }
                        });

                        console.log("动态规划图表(每日价格版)渲染完成。");
                    } catch (error) {
                        console.error("渲染动态规划每日价格图表时出错:", error);
                    }
                },
                runElasticityModelAndShowResults() {
                    console.log("运行需求弹性模型并显示结果...");
                    
                    // 清理相关图表
                    resetChart('elasticityChart');
                    
                    // 先运行模型计算结果 (异步)
                    this.runElasticityModel().then(() => {
                        // 切换视图
                    this.elasticityView = 'results';
                    
                    // 使用延时确保视图切换完成后再次尝试渲染图表
                    setTimeout(() => {
                        console.log("视图切换后重新渲染弹性图表...");
                            // 显式传递数据
                            this.renderElasticityChart(this.modelResults.elasticity);
                    }, 300);
                    });
                },
                runGameTheoryModelAndShowResults() {
                    console.log("运行博弈论模型并显示结果...");
                    
                    // 清理相关图表
                    resetChart('gametheoryChart');
                    
                    // 先运行模型计算结果 (异步)
                    this.runGameTheoryModel().then(() => {
                        // 切换视图
                    this.gametheoryView = 'results';
                    
                    // 使用延时确保视图切换完成后再次尝试渲染图表
                    setTimeout(() => {
                        console.log("视图切换后重新渲染博弈论图表...");
                        this.renderGameTheoryChart();
                    }, 300);
                    });
                },
                runDynamicDPModelAndShowResults() {
                    console.log("运行动态规划模型并显示结果...");
                    
                    // 清理相关图表 - 内部渲染函数会处理销毁
                    // resetChart('dynamicDPChart'); 
                    
                    // 先运行模型计算结果 (异步)
                    this.runDynamicProgrammingModel().then(() => {
                         // 切换视图，这会由 runDynamicProgrammingModel 内部的API回调来设置 this.dynamicDPView = 'results';
                         // this.dynamicDPView = 'results'; // 这行可能多余，因为 runDynamicProgrammingModel 内部会做
                    
                        // $nextTick 确保在DOM更新后尝试渲染，以防 runDynamicProgrammingModel 中的渲染时机不对
                        this.$nextTick(() => {
                            if ((this.activeView === 'dynamicprogramming' || this.activeView === 'dynamicdp') && this.dynamicDPView === 'results' && this.modelResults.dynamicDP) {
                                console.log("runDynamicDPModelAndShowResults: 视图切换后尝试渲染动态规划图表...");
                                this.renderDynamicProgrammingChart(this.modelResults.dynamicDP); // 传递数据
                            } else {
                                console.log('runDynamicDPModelAndShowResults: DP chart rendering skipped, view/data not ready.');
                            }
                        });
                    });
                },
                setActiveView(view) {
                    console.log(`正在切换视图从 ${this.activeView} 到 ${view}`);
                    
                    // 如果是相同视图，不需要重新渲染
                    if (this.activeView === view) {
                        console.log("相同视图，无需切换");
                        return;
                    }
                    
                    // 清理所有可能的图表
                    console.log("清理所有图表...");
                    
                    // 使用全局图表清理函数销毁所有图表
                    resetChart('dashboardRevenueChart'); 
                    resetChart('dashboardUtilizationChart');
                    resetChart('priceOptimizationChart');
                    resetChart('computationSpeedChart');
                    resetChart('marketSensitivityChart');
                    resetChart('predictionAccuracyChart');
                    resetChart('adaptabilityChart');
                    resetChart('elasticityChart');
                    resetChart('gametheoryChart');
                    resetChart('dynamicDPChart');
                    
                    // 更新当前活动视图
                    this.activeView = view;
                    console.log(`视图已切换到: ${view}`);
                    
                    // 延迟执行视图特定的初始化
                    setTimeout(() => {
                        try {
                            // 如果切换到仪表板，初始化仪表板图表
                            if (view === 'dashboard') {
                                console.log("初始化仪表板图表...");
                                this.initializeDashboardCharts();
                                // 重新计算当前预订期并加载数据 (如果需要的话)
                                this.calculateCurrentBookingPeriod();
                                // 确保selectedDate有效
                                this.ensureValidSelectedDate();
                                // 触发数据加载
                                this.fetchAndDisplayDashboardPrices();
                            }
                            
                            // 如果切换到一个有结果视图的模型，延迟渲染图表
                            if (view === 'elasticity' && this.elasticityView === 'results' && this.modelResults.elasticity) {
                                console.log("重新渲染弹性图表...");
                                // 显式传递数据
                                this.renderElasticityChart(this.modelResults.elasticity);
                            }
                            
                            if (view === 'gametheory' && this.gametheoryView === 'results' && this.modelResults.gametheory) {
                                console.log("重新渲染博弈论图表...");
                                this.renderGameTheoryChart(this.modelResults.gametheory);
                            }
                            
                            if (view === 'dynamicprogramming' && this.dynamicDPView === 'results' && this.modelResults.dynamicDP) {
                                console.log("重新渲染动态规划图表...");
                                this.renderDynamicProgrammingChart(this.modelResults.dynamicDP);
                            }
                        } catch (error) {
                            console.error("视图初始化错误:", error);
                        }
                    }, 300);
                },
                // 新增: 确保 selectedDate 在有效范围内 (更新逻辑)
                ensureValidSelectedDate() {
                    const today = this.getFormattedDate(new Date()); 

                     if (!this.dashboardConfig.selectedDate || 
                        new Date(this.dashboardConfig.selectedDate + 'T00:00:00') < new Date(today + 'T00:00:00') ) { 
                        
                        this.dashboardConfig.selectedDate = today; // Watcher will pick this up
                        console.log(`ensureValidSelectedDate: selectedDate was invalid or past, set to ${today}. Watcher will handle period calculation.`);
                        // No need to call calculateCurrentBookingPeriod here, watcher for selectedDate will do it.
                         } else {
                        // selectedDate is valid (e.g. from localStorage or already today/future). 
                        // Explicitly calculate period to ensure bookingStartDate is set correctly on initial load or if no change.
                        this.calculateCurrentBookingPeriod();
                        console.log(`ensureValidSelectedDate: selectedDate ${this.dashboardConfig.selectedDate} is valid. Period calculated. bookingStartDate: ${this.dashboardConfig.bookingStartDate}`);
                     }
                },
                initializeDashboardCharts() {
                    console.log("开始初始化仪表板图表...");
                    
                    // 使用延时确保DOM已经完全渲染
                    setTimeout(() => {
                        try {
                            // 确保所有仪表板图表先被清理
                            resetChart('dashboardRevenueChart');
                            resetChart('dashboardUtilizationChart');
                            resetChart('priceOptimizationChart');
                            resetChart('computationSpeedChart');
                            resetChart('marketSensitivityChart');
                            resetChart('predictionAccuracyChart');
                            resetChart('adaptabilityChart');
                            
                            // 按顺序初始化图表，并在每个初始化之间添加短暂延时
                                this.initializeRevenueChart();
                                
                                setTimeout(() => {
                                    this.initializeUtilizationChart();
                                
                                setTimeout(() => {
                                    this.initializeModelComparisonChart();
                                }, 100);
                            }, 100);
                            
                        } catch (error) {
                            console.error("初始化仪表板图表时出错:", error);
                        }
                    }, 200);
                },
                initializeRevenueChart() {
                    try {
                        console.log("开始初始化收益比较图表...");
                        const canvas = document.getElementById('dashboardRevenueChart');
                        if (!canvas) {
                            console.error("找不到dashboardRevenueChart元素");
                            return;
                        }
                        
                        // 使用全局图表清理函数
                        resetChart('dashboardRevenueChart');
                        
                        const ctx = canvas.getContext('2d');
                        
                        chartInstances['dashboardRevenueChart'] = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: ['需求弹性', '博弈论', '动态规划'],
                                datasets: [
                                    {
                                        label: '基准收益',
                                        data: [8500000, 7800000, 9500000],
                                        backgroundColor: 'rgba(201, 203, 207, 0.7)',
                                        borderColor: 'rgba(201, 203, 207, 1)',
                                        borderWidth: 1
                                    },
                                    {
                                        label: '优化收益',
                                        data: [9900000, 9650000, 11400000],
                                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                                        borderColor: 'rgba(54, 162, 235, 1)',
                                        borderWidth: 1
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        position: 'top',
                                    },
                                    title: {
                                        display: true,
                                        text: '各模型收益比较'
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: '收益 (元)'
                                        }
                                    }
                                }
                            }
                        });
                        console.log("收益比较图表初始化完成");
                    } catch (error) {
                        console.error("初始化收益比较图表时出错:", error);
                    }
                },
                initializeUtilizationChart() {
                    try {
                        console.log("开始初始化资源利用率图表...");
                        const canvas = document.getElementById('dashboardUtilizationChart');
                        if (!canvas) {
                            console.error("找不到dashboardUtilizationChart元素");
                            return;
                        }
                        
                        // 使用全局图表清理函数
                        resetChart('dashboardUtilizationChart');
                        
                        const ctx = canvas.getContext('2d');
                        
                        chartInstances['dashboardUtilizationChart'] = new Chart(ctx, {
                            type: 'radar',
                            data: {
                                labels: ['载重利用率', '体积利用率', '价格优化度', '收益提升度', '运营效率'],
                                datasets: [
                                    {
                                        label: '动态规划模型',
                                        data: [91, 85, 88, 86, 82],
                                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                        borderColor: 'rgba(255, 99, 132, 1)',
                                        borderWidth: 2,
                                        pointBackgroundColor: 'rgba(255, 99, 132, 1)'
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        position: 'top',
                                    },
                                    title: {
                                        display: true,
                                        text: '动态规划模型资源利用率'
                                    }
                                },
                                scales: {
                                    r: {
                                        angleLines: {
                                            display: true
                                        },
                                        suggestedMin: 40,
                                        suggestedMax: 100
                                    }
                                }
                            }
                        });
                        console.log("资源利用率图表初始化完成");
                    } catch (error) {
                        console.error("初始化资源利用率图表时出错:", error);
                    }
                },
                initializeModelComparisonChart() {
                    try {
                        console.log("开始初始化模型比较详情图表...");
                        
                        // 初始化所有比较图表
                        this.initializePriceOptimizationChart();
                        this.initializeComputationSpeedChart();
                        this.initializeMarketSensitivityChart();
                        this.initializePredictionAccuracyChart();
                        this.initializeAdaptabilityChart();
                        
                        // 添加按钮点击事件处理
                        this.setupComparisonTabEvents();
                        
                        console.log("模型比较详情图表初始化完成");
                    } catch (error) {
                        console.error("初始化模型比较详情图表时出错:", error);
                    }
                },
                setupComparisonTabEvents() {
                    // 获取所有按钮和容器
                    const buttons = [
                        'btn-price-optimization',
                        'btn-computation-speed',
                        'btn-market-sensitivity',
                        'btn-prediction-accuracy',
                        'btn-adaptability'
                    ];
                    
                    const containers = [
                        'price-optimization-container',
                        'computation-speed-container',
                        'market-sensitivity-container',
                        'prediction-accuracy-container',
                        'adaptability-container'
                    ];
                    
                    // 设置按钮点击事件
                    buttons.forEach((btnId, index) => {
                        const btn = document.getElementById(btnId);
                        if (btn) {
                            btn.addEventListener('click', () => {
                                // 更新按钮状态
                                buttons.forEach(id => {
                                    const otherBtn = document.getElementById(id); // 获取按钮元素
                                    if(otherBtn) otherBtn.classList.remove('active'); // 检查是否存在
                                });
                                btn.classList.add('active');
                                
                                // 更新容器显示状态
                                containers.forEach((containerId, containerIndex) => {
                                    const container = document.getElementById(containerId);
                                    if (container) {
                                        container.style.display = containerIndex === index ? 'block' : 'none';
                                    }
                                });
                            });
                        }
                    });
                },
                initializePriceOptimizationChart() {
                    try {
                        const canvas = document.getElementById('priceOptimizationChart');
                        if (!canvas) {
                            console.error("找不到priceOptimizationChart元素");
                            return;
                        }
                        
                        resetChart('priceOptimizationChart');
                        
                        const ctx = canvas.getContext('2d');
                        chartInstances['priceOptimizationChart'] = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: ['需求弹性模型', '博弈论模型', '动态规划模型'],
                                datasets: [{
                                    label: '价格优化能力评分',
                                    data: [75, 85, 90],
                                    backgroundColor: [
                                        'rgba(54, 162, 235, 0.7)',
                                        'rgba(75, 192, 192, 0.7)',
                                        'rgba(255, 99, 132, 0.7)'
                                    ],
                                    borderColor: [
                                        'rgba(54, 162, 235, 1)',
                                        'rgba(75, 192, 192, 1)',
                                        'rgba(255, 99, 132, 1)'
                                    ],
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                return `评分: ${context.raw}/100`;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        max: 100,
                                        title: {
                                            display: true,
                                            text: '评分 (0-100)'
                                        }
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error("初始化价格优化能力图表时出错:", error);
                    }
                },
                initializeComputationSpeedChart() {
                    try {
                        const canvas = document.getElementById('computationSpeedChart');
                        if (!canvas) {
                            console.error("找不到computationSpeedChart元素");
                            return;
                        }
                        
                        resetChart('computationSpeedChart');
                        
                        const ctx = canvas.getContext('2d');
                        chartInstances['computationSpeedChart'] = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: ['需求弹性模型', '博弈论模型', '动态规划模型'],
                                datasets: [{
                                    label: '计算速度评分',
                                    data: [95, 70, 60],
                                    backgroundColor: [
                                        'rgba(54, 162, 235, 0.7)',
                                        'rgba(75, 192, 192, 0.7)',
                                        'rgba(255, 99, 132, 0.7)'
                                    ],
                                    borderColor: [
                                        'rgba(54, 162, 235, 1)',
                                        'rgba(75, 192, 192, 1)',
                                        'rgba(255, 99, 132, 1)'
                                    ],
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                return `评分: ${context.raw}/100`;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        max: 100,
                                        title: {
                                            display: true,
                                            text: '评分 (0-100)'
                                        }
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error("初始化计算速度图表时出错:", error);
                    }
                },
                initializeMarketSensitivityChart() {
                    try {
                        const canvas = document.getElementById('marketSensitivityChart');
                        if (!canvas) {
                            console.error("找不到marketSensitivityChart元素");
                            return;
                        }
                        
                        resetChart('marketSensitivityChart');
                        
                        const ctx = canvas.getContext('2d');
                        chartInstances['marketSensitivityChart'] = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: ['需求弹性模型', '博弈论模型', '动态规划模型'],
                                datasets: [{
                                    label: '市场敏感度评分',
                                    data: [65, 90, 80],
                                    backgroundColor: [
                                        'rgba(54, 162, 235, 0.7)',
                                        'rgba(75, 192, 192, 0.7)',
                                        'rgba(255, 99, 132, 0.7)'
                                    ],
                                    borderColor: [
                                        'rgba(54, 162, 235, 1)',
                                        'rgba(75, 192, 192, 1)',
                                        'rgba(255, 99, 132, 1)'
                                    ],
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                return `评分: ${context.raw}/100`;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        max: 100,
                                        title: {
                                            display: true,
                                            text: '评分 (0-100)'
                                        }
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error("初始化市场敏感度图表时出错:", error);
                    }
                },
                initializePredictionAccuracyChart() {
                    try {
                        const canvas = document.getElementById('predictionAccuracyChart');
                        if (!canvas) {
                            console.error("找不到predictionAccuracyChart元素");
                            return;
                        }
                        
                        resetChart('predictionAccuracyChart');
                        
                        const ctx = canvas.getContext('2d');
                        chartInstances['predictionAccuracyChart'] = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: ['需求弹性模型', '博弈论模型', '动态规划模型'],
                                datasets: [{
                                    label: '预测准确度评分',
                                    data: [70, 75, 85],
                                    backgroundColor: [
                                        'rgba(54, 162, 235, 0.7)',
                                        'rgba(75, 192, 192, 0.7)',
                                        'rgba(255, 99, 132, 0.7)'
                                    ],
                                    borderColor: [
                                        'rgba(54, 162, 235, 1)',
                                        'rgba(75, 192, 192, 1)',
                                        'rgba(255, 99, 132, 1)'
                                    ],
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                return `评分: ${context.raw}/100`;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        max: 100,
                                        title: {
                                            display: true,
                                            text: '评分 (0-100)'
                                        }
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error("初始化预测准确度图表时出错:", error);
                    }
                },
                initializeAdaptabilityChart() {
                    try {
                        const canvas = document.getElementById('adaptabilityChart');
                        if (!canvas) {
                            console.error("找不到adaptabilityChart元素");
                            return;
                        }
                        
                        resetChart('adaptabilityChart');
                        
                        const ctx = canvas.getContext('2d');
                        chartInstances['adaptabilityChart'] = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: ['需求弹性模型', '博弈论模型', '动态规划模型'],
                                datasets: [{
                                    label: '适应性评分',
                                    data: [80, 65, 90],
                                    backgroundColor: [
                                        'rgba(54, 162, 235, 0.7)',
                                        'rgba(75, 192, 192, 0.7)',
                                        'rgba(255, 99, 132, 0.7)'
                                    ],
                                    borderColor: [
                                        'rgba(54, 162, 235, 1)',
                                        'rgba(75, 192, 192, 1)',
                                        'rgba(255, 99, 132, 1)'
                                    ],
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                return `评分: ${context.raw}/100`;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        max: 100,
                                        title: {
                                            display: true,
                                            text: '评分 (0-100)'
                                        }
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error("初始化适应性图表时出错:", error);
                    }
                },
                // 更新航线信息
                updateRouteInfo(route) {
                    this.routeInfo = { ...route };
                    this.calculatePricing(); // 注意: calculatePricing 可能需要调整
                },
                
                // 更新机型信息
                updateAircraftInfo(aircraft) {
                    this.aircraftInfo = { ...aircraft };
                    this.updateModelsWithAircraftData(); // 确保模型参数更新
                    this.calculatePricing(); // 注意: calculatePricing 可能需要调整
                },
                
                // 修改计算价格方法 - 现在这个方法可能不直接用于运行模型，而是由 fetchAndDisplayDashboardPrices 触发
                calculatePricing() {
                    console.warn("calculatePricing 方法被调用，但现在主要通过 fetchAndDisplayDashboardPrices 获取数据。")
                    // 暂时保留，如果其他地方仍在使用
                     this.fetchAndDisplayDashboardPrices(); // 直接调用新的获取方法
                },
                
                // 调用弹性定价API
                calculateElasticityPricing(requestData) {
                    // 确保有必要的参数
                    const completeRequestData = {
                        ...requestData,
                        distance: this.routeInfo.distance || 1200,
                        flight_type: this.routeInfo.flight_type || '干线',
                        popularity: this.routeInfo.popularity || 'medium',
                        season_factor: this.routeInfo.season_factor || 1.0,
                        market_share: this.routeInfo.market_share || 0.5, // 可能需要默认值
                        flight_frequency: this.routeInfo.flight_frequency || 7 // 可能需要默认值
                    };
                    
                    // 移除: 预订期阶段相关逻辑 (已固定)
                    // if (this.elasticity.useBookingStages) ...
                    
                    this.elasticityView = 'loading';
                    
                    fetch(`${this.apiBaseUrl}/api/elasticity/calculate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(completeRequestData)
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`API错误 ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("弹性定价API返回结果:", data);
                        
                        // 处理API返回结果
                        if (data.status === 'success') {
                            this.modelResults.elasticity = data;
                            this.elasticityView = 'results'; // 先设置视图状态
                            this.renderElasticityChart(data); // 然后渲染图表 (内部已有$nextTick)
                             // this.checkAndDisplayDashboardBestPrice(); 
                        } else {
                            throw new Error(data.message || '未知错误');
                        }
                    })
                    .catch(error => {
                        console.error("弹性定价API调用失败:", error);
                        alert(`弹性定价计算失败: ${error.message}`);
                        this.elasticityView = 'config';
                    })
                    .finally(() => {
                         this.elasticityLoading = false; // 确保加载结束
                    });
                },
                
                // 调用博弈论API
                calculateGameTheoryPricing(requestData) {
                    // 确保有必要的参数
                    const completeRequestData = {
                        ...requestData,
                        distance: this.routeInfo.distance || 1200,
                        flight_type: this.routeInfo.flight_type || '干线',
                        popularity: this.routeInfo.popularity || 'medium',
                        season_factor: this.routeInfo.season_factor || 1.0,
                        market_share: this.routeInfo.market_share || 0.5,
                        flight_frequency: this.routeInfo.flight_frequency || 7
                    };
                    
                    // 确保数值参数的类型正确
                    if (completeRequestData.time_periods) {
                        completeRequestData.time_periods = parseInt(completeRequestData.time_periods);
                    }
                    if (completeRequestData.k_value) {
                        completeRequestData.k_value = parseFloat(completeRequestData.k_value);
                    }
                    
                    this.gametheoryView = 'loading';
                    
                    fetch(`${this.apiBaseUrl}/api/gametheory/calculate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(completeRequestData)
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`API错误 ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("博弈论API返回结果:", data);
                        
                        // 处理API返回结果
                        if (data.status === 'success') {
                            this.modelResults.gametheory = data;
                            this.renderGameTheoryChart(data); // 渲染图表
                            this.gametheoryView = 'results';
                        } else {
                            throw new Error(data.message || '未知错误');
                        }
                    })
                    .catch(error => {
                        console.error("博弈论API调用失败:", error);
                        alert(`博弈论定价计算失败: ${error.message}`);
                        this.gametheoryView = 'config';
                    })
                     .finally(() => {
                         this.gametheoryLoading = false; // 确保加载结束
                    });
                },
                
                // 调用动态规划API
                calculateDynamicProgrammingPricing(requestData) {
                    // 确保有必要的参数
                    const completeRequestData = {
                        ...requestData,
                        distance: this.routeInfo.distance || 1200,
                        flight_type: this.routeInfo.flight_type || '干线',
                        popularity: this.routeInfo.popularity || 'medium',
                        season_factor: this.routeInfo.season_factor || 1.0,
                        market_share: this.routeInfo.market_share || 0.5,
                        flight_frequency: this.routeInfo.flight_frequency || 7
                    };
                    
                    this.dynamicDPView = 'loading';
                    
                    fetch(`${this.apiBaseUrl}/api/dynamicdp/calculate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(completeRequestData)
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`API错误 ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("DP API返回结果:", data);
                        
                        // 处理API返回结果
                        if (data.status === 'success') {
                            this.modelResults.dynamicDP = data;
                            this.dynamicDPView = 'results'; // 先更新视图状态

                            this.$nextTick(() => {
                                // 确保视图激活且数据已准备好
                                if ((this.activeView === 'dynamicprogramming' || this.activeView === 'dynamicdp') && this.dynamicDPView === 'results' && this.modelResults.dynamicDP) {
                                    this.renderDynamicProgrammingChart(data); // 然后在DOM更新后渲染图表
                                } else {
                                    console.log('DP chart rendering skipped in API callback: view not active or data not ready in $nextTick.');
                                }
                            });
                             // this.checkAndDisplayDashboardBestPrice(); 
                        } else {
                            throw new Error(data.message || '未知错误');
                        }
                    })
                    .catch(error => {
                        console.error("DP API调用失败:", error);
                        alert(`动态规划定价计算失败: ${error.message}`);
                        this.dynamicDPView = 'config';
                    })
                     .finally(() => {
                         this.dynamicDPLoading = false; // 确保加载结束
                    });
                },
                
                // 加载航线配置
                loadRoute(route) {
                    // 设置路线信息
                    this.routeInfo = { ...route }; // 使用扩展运算符复制所有属性
                    
                     // 移除: 更新预订期逻辑
                     // if (route.defaultBookingPeriod) ...
                    
                    // 显示确认消息
                    this.$nextTick(() => {
                        alert(`已加载路线: ${route.origin} → ${route.destination}`);
                        // 加载航线后，重新获取价格
                        this.fetchAndDisplayDashboardPrices();
                    });
                },
                
                // 加载机型配置
                loadAircraft(aircraft) {
                    this.aircraftInfo = { ...aircraft };
                    // 更新各个模型的相关参数
                    this.updateModelsWithAircraftData();
                    // 加载机型后，重新获取价格
                     this.fetchAndDisplayDashboardPrices(); 
                    // 移除: this.calculatePricing();
                },
                
                // 保存航线配置
                saveRouteConfig() {
                    // 保存路线配置到本地存储
                    localStorage.setItem('savedRouteConfig', JSON.stringify(this.routeInfo));
                    
                    // 显示确认消息
                    alert('航线配置已保存!');
                },
                
                // 保存机型配置
                saveAircraftConfig() {
                    // 保存到本地存储
                    localStorage.setItem('aircraftConfig', JSON.stringify(this.aircraftInfo));
                    // 更新各个模型的相关参数
                    this.updateModelsWithAircraftData();
                    alert('机型配置已保存');
                     // 保存后重新获取价格
                     this.fetchAndDisplayDashboardPrices();
                },
                
                // 根据机型配置更新各模型参数
                updateModelsWithAircraftData() {
                    // 获取机型容量
                    const maxPayload = this.aircraftInfo.max_payload || 6964; // 如果没有则默认A320基础
                    const maxVolume = this.aircraftInfo.max_volume || 500000;
                    
                    // 更新需求弹性模型参数
                    // 移除：不再根据机型调整初始价格
                    /* 
                    const weightFactor = Math.sqrt(maxPayload / 20000); // 以B737F为基准
                    this.elasticity.initialPrices = {
                        express: Math.round(12 * weightFactor * 10) / 10,
                        fresh: Math.round(7 * weightFactor * 10) / 10,
                        regular: Math.round(6 * weightFactor * 10) / 10
                    };
                    */
                    
                    // 更新博弈论模型参数
                    // 修改：严格按照论文案例公式计算容量
                    const frequency1 = 6;
                    const frequency2 = 5;
                    const selfSaleRatio = 0.4;
                    this.gametheory.companies[0].initial_capacity = Math.round(maxPayload * frequency1 * selfSaleRatio);
                    this.gametheory.companies[1].initial_capacity = Math.round(maxPayload * frequency2 * selfSaleRatio);
                    
                    // 移除：不再根据机型调整初始价格
                    /*
                    this.gametheory.companies[0].initialPrice = Math.round(5.8 * weightFactor * 10) / 10;
                    this.gametheory.companies[1].initialPrice = Math.round(7.0 * weightFactor * 10) / 10;
                    */
                    
                    // 更新动态规划模型参数
                    this.dynamicDP.capacityWeight = maxPayload;
                    this.dynamicDP.capacityVolume = maxVolume;
                    
                    // 记录每次更新的机型数据，便于调试
                    console.log(`已根据机型数据(载重:${maxPayload}kg,体积:${maxVolume}cm³)更新各模型参数`);
                    console.log(`博弈论容量已按论文公式更新: 公司1=${this.gametheory.companies[0].initial_capacity}kg, 公司2=${this.gametheory.companies[1].initial_capacity}kg`);
                    console.log("当前机型配置:", JSON.stringify(this.aircraftInfo));
                    console.log("注意：初始价格不再随选定机型自动调整。"); // 添加提示
                },
                
                // 获取模型特定参数
                getModelSpecificParams(modelType) {
                    const params = {};
                    
                    if (modelType === 'elasticity') {
                        params.price_elasticity = this.elasticity.priceElasticity;
                        params.initial_prices = this.elasticity.initialPrices;
                        // cargo_types is more of a filter on UI, backend model might infer from initial_prices/elasticities keys
                        // params.cargo_types_config = this.elasticity.cargoTypes; // How backend expects this?
                        params.booking_period = 14; 
                    } else if (modelType === 'gametheory') {
                        params.k_value = parseFloat(this.gametheory.kValue);
                        params.companies = this.gametheory.companies;
                        params.time_periods = parseInt(this.gametheory.timePeriods);
                    } else if (modelType === 'dynamicdp') { // Corrected 'dynamicprogramming' to 'dynamicdp' to match usage
                        params.booking_period = 14;
                        // max_payload and max_volume are in baseParams from getBaseModelParams()
                        params.gamma = this.dynamicDP.gamma;
                        params.C_D_ratio = this.dynamicDP.C_D_ratio;
                    }
                    return params;
                },
                // 获取预订阶段名称
                getBookingStageName(index) {
                    const stageNames = ["早期", "中期", "晚期", "临近", "紧急"];
                    return index >= 0 && index < stageNames.length ? stageNames[index] : `阶段${index+1}`;
                },
                // 切换价格详情显示状态
                togglePriceChangeDetail() {
                    this.showPriceChangeDetail = !this.showPriceChangeDetail;
                },
                // 计算价格变化百分比
                calculatePriceChange(priceTable, priceField) {
                    if (!priceTable || priceTable.length < 2) return "0.0";
                    const initialPrice = Number(priceTable[0][priceField]);
                    const finalPrice = Number(priceTable[priceTable.length-1][priceField]);
                     // 添加检查避免除以零
                    if (initialPrice === 0) return "N/A";
                    return ((finalPrice / initialPrice - 1) * 100).toFixed(1);
                },
                // 改进的博弈论图表渲染函数
                renderGameTheoryChart() {
                    // 检查是否存在结果数据
                    if (!this.modelResults.gametheory || 
                        !this.modelResults.gametheory.priceTable || 
                        !Array.isArray(this.modelResults.gametheory.priceTable) ||
                        this.modelResults.gametheory.priceTable.length === 0) {
                        console.error("没有可用的博弈论模型结果数据(priceTable)");
                        // 可以选择在这里清理图表或显示提示信息
                        resetChart('gametheoryChart');
                        const canvas = document.getElementById('gametheoryChart');
                        if (canvas && canvas.parentElement) {
                             canvas.parentElement.innerHTML = '<div class="alert alert-warning">博弈论模型数据不可用或格式不正确。</div>';
                        }
                        return;
                    }
                    
                    // 确保之前的图表实例被清理
                    resetChart('gametheoryChart');
                    
                    // 处理数据
                    const priceTable = this.modelResults.gametheory.priceTable;
                    const labels = priceTable.map((_, idx) => `时段 ${idx + 1}`);
                    const company1Prices = priceTable.map(item => Number(item.price1));
                    const company2Prices = priceTable.map(item => Number(item.price2));
                    
                    // --- 添加对 companies 的防御性检查 ---
                    let company1Name = '公司1'; // 默认名称
                    let company2Name = '公司2'; // 默认名称
                    if (this.modelResults.gametheory.companies && 
                        Array.isArray(this.modelResults.gametheory.companies) && 
                        this.modelResults.gametheory.companies.length > 0) {
                        
                        company1Name = (this.modelResults.gametheory.companies[0] && this.modelResults.gametheory.companies[0].name) ? this.modelResults.gametheory.companies[0].name : company1Name;
                        
                        if (this.modelResults.gametheory.companies.length > 1) {
                            company2Name = (this.modelResults.gametheory.companies[1] && this.modelResults.gametheory.companies[1].name) ? this.modelResults.gametheory.companies[1].name : company2Name;
                        } else {
                            console.warn("博弈论模型结果只包含一个公司的数据，图表可能只显示一个公司。");
                            // company2Name 将保持默认值 '公司2'，其价格数据 company2Prices 可能为空或无效
                        }
                    } else {
                        console.warn("博弈论模型结果缺少公司信息 (this.modelResults.gametheory.companies)，将使用默认公司名称。");
                    }
                    // --- 结束检查 ---
                    
                    // 创建新图表
                    const canvas = document.getElementById('gametheoryChart');
                     if (!canvas) {
                        console.error("未找到 gametheoryChart 元素");
                        return;
                    }
                    // 如果之前因为错误替换了canvas, 需要重新创建它
                    if (canvas.tagName !== 'CANVAS') {
                        if(canvas.parentElement) {
                            canvas.parentElement.innerHTML = '<canvas id="gametheoryChart" height="300"></canvas>';
                            canvas = document.getElementById('gametheoryChart');
                            if (!canvas) {
                                console.error("重新创建 gametheoryChart canvas 失败");
                                return;
                            }
                        } else {
                             console.error("gametheoryChart 的父元素不存在，无法重新创建 canvas");
                             return;
                        }
                    }

                    const ctx = canvas.getContext('2d');
                     if (!ctx) {
                        console.error("无法获取 gametheoryChart canvas 上下文");
                        return;
                    }

                    const datasets = [];
                    // 验证 company1Prices
                    if (Array.isArray(company1Prices) && company1Prices.length > 0 && company1Prices.every(p => typeof p === 'number')) {
                        datasets.push({
                            label: company1Name + ' 价格',
                                    data: company1Prices,
                                    borderColor: '#0d6efd',
                                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                                    borderWidth: 3,
                                    pointRadius: 4,
                                    tension: 0.3,
                                    fill: false
                        });
                    } else {
                        console.warn("GameTheoryChart: company1Prices 无效或为空，不添加到图表。");
                    }


                    // 仅当有两个公司的数据时才添加第二个数据集，并验证 company2Prices
                    if (this.modelResults.gametheory.companies &&
                        Array.isArray(this.modelResults.gametheory.companies) &&
                        this.modelResults.gametheory.companies.length > 1 &&
                        Array.isArray(company2Prices) && company2Prices.length > 0 && company2Prices.every(p => typeof p === 'number')) {
                        datasets.push({
                            label: company2Name + ' 价格',
                                    data: company2Prices,
                                    borderColor: '#198754',
                                    backgroundColor: 'rgba(25, 135, 84, 0.1)',
                                    borderWidth: 3,
                                    pointRadius: 4,
                                    tension: 0.3,
                                    fill: false
                        });
                    } else {
                         console.warn("GameTheoryChart: company2Prices 无效、为空或公司数据不足，不添加到图表。");
                    }
                    
                    // 验证 labels
                    const validLabels = Array.isArray(labels) && labels.length > 0 ? labels : [];
                    if (validLabels.length === 0) {
                        console.warn("GameTheoryChart: labels 数组为空或无效。");
                        // 可以根据需求决定是否在这里返回，或者允许图表在没有标签的情况下渲染（如果Chart.js支持）
                    }

                    // 如果没有有效的数据集，则不渲染图表
                    if (datasets.length === 0) {
                        console.warn("GameTheoryChart: 没有有效的数据集可供渲染。");
                        // 可以选择清除旧图表或显示提示信息
                        if (chartInstances.gametheoryChart) {
                            chartInstances.gametheoryChart.destroy();
                            chartInstances.gametheoryChart = null;
                        }
                        ctx.clearRect(0, 0, canvas.width, canvas.height); // 清空画布
                        ctx.font = "16px Arial";
                        ctx.fillStyle = "gray";
                        ctx.textAlign = "center";
                        ctx.fillText("博弈论图表无可用数据", canvas.width / 2, canvas.height / 2);
                        return;
                    }

                    chartInstances.gametheoryChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: validLabels, // 使用验证过的 labels
                            datasets: datasets // 使用动态构建的 datasets
                        },
                        options: { // ... (options 保持不变)
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: '博弈论模型价格动态演化',
                                    font: {
                                        size: 16
                                    }
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' 元/kg';
                                        }
                                    }
                                },
                                legend: {
                                    position: 'top',
                                }
                            },
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: '时间段'
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: '价格 (元/kg)'
                                    },
                                    // 安全地计算 Y 轴最小值
                                    min: datasets.length > 0 ? Math.min(...datasets.flatMap(ds => ds.data.filter(d => typeof d === 'number'))) * 0.9 : 0,
                                    ticks: {
                                        callback: function(value) {
                                            return value.toFixed(2);
                                        }
                                    }
                                }
                            },
                            animation: {
                                duration: 1000,
                                easing: 'easeOutQuart'
                            },
                            elements: {
                                line: {
                                    tension: 0.3
                                },
                                point: {
                                    radius: function(context) {
                                        const index = context.dataIndex;
                                        if (index === 0 || index === context.dataset.data.length - 1) {
                                            return 6;
                                        }
                                        return 4;
                                    },
                                    hoverRadius: 8
                                }
                            }
                        }
                    });
                },
                // 新增方法 - 更新综合最优价格数据 (现在使用固定 booking_period)
                updateBestPriceDashboard(useFixedBookingPeriod = false) {
                    try {
                        // Log the raw modelResults to see their structure before trying to access .data
                        console.log("updateBestPriceDashboard: Starting. Raw this.modelResults.elasticity:", JSON.parse(JSON.stringify(this.modelResults.elasticity)));
                        console.log("updateBestPriceDashboard: Starting. Raw this.modelResults.dynamicDP:", JSON.parse(JSON.stringify(this.modelResults.dynamicDP)));

                        // 修改：直接使用模型结果，而不是 .data 属性
                        const elasticityData = this.modelResults.elasticity;
                        const dpData = this.modelResults.dynamicDP;

                        console.log("updateBestPriceDashboard: Using elasticityData:", JSON.parse(JSON.stringify(elasticityData)));
                        console.log("updateBestPriceDashboard: Using dpData:", JSON.parse(JSON.stringify(dpData)));

                        if (!elasticityData || !elasticityData.bookingDaysPriceTable ||
                            !dpData || !dpData.bookingDaysPriceTable) {
                            console.error("Dashboard: Essential data (elasticityData, dpData, or their bookingDaysPriceTable) is missing.");
                            // Log what is actually there
                            console.log("Missing check - elasticityData:", elasticityData, "dpData:", dpData);
                            if (elasticityData) console.log("Missing check - elasticityData.bookingDaysPriceTable:", elasticityData.bookingDaysPriceTable);
                            if (dpData) console.log("Missing check - dpData.bookingDaysPriceTable:", dpData.bookingDaysPriceTable);
                            
                            this.bestPriceDashboard.errorMessage = "模型数据不完整，无法更新仪表盘价格。";
                            return false;
                        }

                        if (!Array.isArray(elasticityData.bookingDaysPriceTable) || !Array.isArray(dpData.bookingDaysPriceTable)) {
                            console.error("Dashboard: bookingDaysPriceTable is not an array in one or both model results.", 
                                          "Elasticity type:", typeof elasticityData.bookingDaysPriceTable, "Is Array:", Array.isArray(elasticityData.bookingDaysPriceTable),
                                          "DP type:", typeof dpData.bookingDaysPriceTable, "Is Array:", Array.isArray(dpData.bookingDaysPriceTable));
                            this.bestPriceDashboard.errorMessage = "模型返回的每日价格数据格式错误 (非数组)。";
                            return false;
                        }


                        if (elasticityData.bookingDaysPriceTable.length === 0 && dpData.bookingDaysPriceTable.length === 0) {
                            console.error("Dashboard: Both elasticity and DP models returned empty bookingDaysPriceTable.");
                            this.bestPriceDashboard.errorMessage = "两个模型均未能返回每日价格数据。";
                            return false;
                        }

                        let calculatedDailyPrices = [];
                        const bookingPeriodToUse = useFixedBookingPeriod ? 14 : (elasticityData.bookingPeriod || dpData.bookingPeriod || 14);
                        
                        if (!this.dashboardConfig.bookingStartDate) {
                            console.error("updateBestPriceDashboard: bookingStartDate is not set in dashboardConfig!");
                            this.bestPriceDashboard.errorMessage = "预订起始日期未设定，无法计算每日价格。";
                            return false;
                    }
                        const startDate = new Date(this.dashboardConfig.bookingStartDate);

                        for (let d = 1; d <= bookingPeriodToUse; d++) {
                            const actualDate = new Date(startDate);
                            actualDate.setDate(startDate.getDate() + d - 1);
                            const formattedDate = actualDate.toISOString().split('T')[0];

                            let elasticityPricesForDay = {};
                            if (elasticityData.bookingDaysPriceTable) {
                                elasticityData.bookingDaysPriceTable.forEach(typeData => {
                                    // 弹性模型的 dailyPrices 是一个直接的价格数组
                                    // typeData.cargoType (e.g., "普货")
                                    if (typeData && typeData.cargoType && typeData.dailyPrices && Array.isArray(typeData.dailyPrices) && typeData.dailyPrices.length >= d) {
                                        const standardKey = this.cargoTypeMapping.elasticity[typeData.cargoType];
                                        if (standardKey) {
                                            elasticityPricesForDay[standardKey] = typeData.dailyPrices[d - 1];
                                        } else if (d === 1) {
                                            console.warn(`updateBestPriceDashboard (d=1): Elasticity - Unknown cargoType '${typeData.cargoType}' or mapping missing.`);
                                        }
                                    } else if (d === 1) {
                                        console.warn(`updateBestPriceDashboard (d=1): Elasticity typeData or dailyPrices missing/malformed for type: ${typeData ? typeData.cargoType : 'N/A'}. DailyPrices:`, typeData ? typeData.dailyPrices : 'N/A', 'Array Check:', Array.isArray(typeData.dailyPrices), 'Length Check:', typeData.dailyPrices ? typeData.dailyPrices.length >=d : 'N/A');
                                    }
                                });
                            }

                            let dpPricesForDay = {};
                            if (dpData.bookingDaysPriceTable) {
                                dpData.bookingDaysPriceTable.forEach(typeData => {
                                    // DP 模型的 dailyPrices 是对象数组 [{day:1, price:X}, ...]
                                    // typeData.bookingType (e.g., "小型快件")
                                    if (typeData && typeData.bookingType && typeData.dailyPrices && Array.isArray(typeData.dailyPrices)) {
                                        const priceEntry = typeData.dailyPrices.find(p => p && p.day === d);
                                        if (priceEntry) {
                                            const standardKey = this.cargoTypeMapping.dynamicDP[typeData.bookingType];
                                            if (standardKey) {
                                                dpPricesForDay[standardKey] = priceEntry.price;
                                            } else if (d === 1) {
                                                 console.warn(`updateBestPriceDashboard (d=1): DP - Unknown bookingType '${typeData.bookingType}' or mapping missing.`);
                                            }
                                    }
                                    } else if (d === 1) {
                                        console.warn(`updateBestPriceDashboard (d=1): DP typeData or dailyPrices missing/malformed for type: ${typeData ? typeData.bookingType : 'N/A'}. DailyPrices:`, typeData ? typeData.dailyPrices : 'N/A');
                                    }
                                });
                            }
                            
                            if (d === 1) {
                                console.log(`updateBestPriceDashboard (d=1): Extracted elasticityPricesForDay (standard keys):`, JSON.parse(JSON.stringify(elasticityPricesForDay)), `Extracted dpPricesForDay (standard keys):`, JSON.parse(JSON.stringify(dpPricesForDay)));
                            }

                            let combinedPricesForDay = [];
                            // 使用 this.bookingTypes (它包含标准键: 'express', 'fresh', 'regular')
                            this.bookingTypes.forEach(stdTypeKey => {
                                const elPrice = elasticityPricesForDay[stdTypeKey];
                                const dpPrice = dpPricesForDay[stdTypeKey];
                                let chosenPrice;
                                let sourceModel = '';
                                
                                const cargoDisplayName = (this.cargoConfig && this.cargoConfig[stdTypeKey] && this.cargoConfig[stdTypeKey].name) ? this.cargoConfig[stdTypeKey].name : stdTypeKey;


                                if (elPrice !== undefined && dpPrice !== undefined) {
                                    chosenPrice = Math.max(elPrice, dpPrice); // 或者其他比较逻辑
                                    sourceModel = elPrice >= dpPrice ? '弹性模型' : '动态规划';
                                } else if (elPrice !== undefined) {
                                    chosenPrice = elPrice;
                                    sourceModel = '弹性模型';
                                } else if (dpPrice !== undefined) {
                                    chosenPrice = dpPrice;
                                    sourceModel = '动态规划';
                            }
                            
                                if (chosenPrice !== undefined) {
                                    combinedPricesForDay.push({
                                        standardKey: stdTypeKey, // 存储标准键
                                        cargoType: cargoDisplayName, // 用于显示的名称 (从cargoConfig获取)
                                        bestPrice: chosenPrice, 
                                        source: sourceModel 
                                    });
                                } else if (d === 1) {
                                     console.warn(`updateBestPriceDashboard (d=1): For stdTypeKey '${stdTypeKey}' (Display: ${cargoDisplayName}), price missing from both models after individual extraction. El price: ${elPrice}, DP price: ${dpPrice}`);
                        }
                            });
                            
                            if (d === 1) {
                                console.log(`updateBestPriceDashboard (d=1): Generated combinedPricesForDay:`, JSON.parse(JSON.stringify(combinedPricesForDay)), `Expected count: ${this.expectedCargoTypesCount}, Actual length: ${combinedPricesForDay.length}`);
                            }

                            if (combinedPricesForDay.length === this.expectedCargoTypesCount) {
                                calculatedDailyPrices.push({
                                    day: d,
                                    date: formattedDate,
                                    prices: combinedPricesForDay
                                });
                            } else {
                                console.warn(`updateBestPriceDashboard: Day ${d} (${formattedDate}): Did not find complete prices. Found ${combinedPricesForDay.length} types, expected ${this.expectedCargoTypesCount}. Elasticity items processed: ${Object.keys(elasticityPricesForDay).length}, DP items processed: ${Object.keys(dpPricesForDay).length}. Combined list for day ${d}:`, JSON.parse(JSON.stringify(combinedPricesForDay)));
                            }
                        }

                        this.bestPriceDashboard.allDailyPrices = calculatedDailyPrices;
                        this.bestPriceDashboard.dailyPricesByDay = {}; // Reset
                        calculatedDailyPrices.forEach(dayData => {
                            this.bestPriceDashboard.dailyPricesByDay[dayData.day] = {
                                date: dayData.date,
                                prices: {} // 初始化为对象，将以 standardKey 为键存储价格信息
                            };
                            dayData.prices.forEach(priceItem => {
                                // priceItem 结构: { standardKey: 'express', cargoType: '快件', bestPrice: X, source: 'Y' }
                                this.bestPriceDashboard.dailyPricesByDay[dayData.day].prices[priceItem.standardKey] = {
                                    displayCargoType: priceItem.cargoType, // 保留显示名称
                                    price: priceItem.bestPrice,
                                    source: priceItem.source
                                };
                            });
                    });
                    
                        console.log("updateBestPriceDashboard: Finished. Populated dailyPricesByDay keys:", Object.keys(this.bestPriceDashboard.dailyPricesByDay).join(', '), "Full dailyPricesByDay (sample for day 1 if exists):", this.bestPriceDashboard.dailyPricesByDay[1] ? JSON.parse(JSON.stringify(this.bestPriceDashboard.dailyPricesByDay[1])) : "Day 1 not found");
                        
                        this.bestPriceDashboard.lastUpdated = new Date().toISOString();
                        this.bestPriceDashboard.currentRoute = `${this.routeInfo.origin} -> ${this.routeInfo.destination}`;
                        this.bestPriceDashboard.currentAircraft = this.aircraftInfo.type;
                        
                        // Only set isDataValid if we actually have some daily prices generated
                        // And if the current selected day can be found.
                        const dayIndexForValidation = this.calculateDayIndex(this.dashboardConfig.selectedDate, this.dashboardConfig.bookingStartDate);
                        this.bestPriceDashboard.isDataValid = calculatedDailyPrices.length > 0 && this.bestPriceDashboard.dailyPricesByDay[dayIndexForValidation] !== undefined;

                        if (!this.bestPriceDashboard.isDataValid) {
                             console.warn("updateBestPriceDashboard: Setting isDataValid to false. Calculated daily prices count:", calculatedDailyPrices.length, "Entry for dayIndex", dayIndexForValidation, "exists:", this.bestPriceDashboard.dailyPricesByDay[dayIndexForValidation] !== undefined);
                        }

                        return this.bestPriceDashboard.isDataValid; // Return true only if data is considered valid and processed.
                    } catch (error) {
                        console.error("updateBestPriceDashboard: CRITICAL ERROR during execution:", error);
                        this.bestPriceDashboard.errorMessage = "更新仪表盘价格时发生严重错误。";
                        this.bestPriceDashboard.isDataValid = false;
                        return false;
                    }
                },
                
                // 修改: 检查并显示仪表盘价格 (使用 selectedDate)
                checkAndDisplayDashboardBestPrice() {
                    // 验证当前配置与API结果是否一致
                    const { isConsistent, mismatchReason } = this.validateConfigWithResults();
                    console.log("检查仪表盘配置与模型结果一致性 (或更新显示)...", isConsistent);
                    
                    if (isConsistent) {
                        console.log("模型结果与当前选择一致，开始更新仪表盘显示...");
                        // 调用 updateBestPriceDashboard 来准备数据
                        const dataProcessed = this.updateBestPriceDashboard(true); // true for fixed 14-day period
                        
                        if (!dataProcessed) {
                            console.warn("checkAndDisplayDashboardBestPrice: updateBestPriceDashboard returned false, indicating data processing issues.");
                            this.bestPriceDashboard.selectedDayPrices = null; // Clear previous prices
                            this.bestPriceDashboard.message = this.bestPriceDashboard.errorMessage || "无法处理模型数据以显示价格。";
                            this.dashboardLoading = false; // <<< 新增：即使处理失败，也结束加载状态
                            return;
                        }

                             } else {
                        console.log("模型结果与当前选择不一致，将尝试重新获取数据。原因:", mismatchReason);
                        // 如果不一致，fetchAndDisplayDashboardPrices 会被调用，它会处理 loading 状态
                        // 这里不再直接调用 fetchAndDisplayDashboardPrices，而是让外部调用者（如watchers）决定是否重新获取
                        // 但如果是由 fetchAndDisplayDashboardPrices 内部调用到这里，则应该已在加载中
                        // 为安全起见，如果决定从这里重新触发，需要小心循环调用
                        // 当前逻辑是：如果外部触发了 checkAndDisplay... 且发现不一致，则外部应重新 fetch
                        // 如果是 fetchAndDisplay... 内部调用了这里（不太可能，因为fetch完会直接更新），则逻辑需调整
                        // 假设此函数主要用于数据已获取后的UI更新和校验
                        this.bestPriceDashboard.message = `模型结果与当前选择 (${mismatchReason}) 不一致，请重新运行或检查配置。`;
                        this.dashboardLoading = false; // <<< 新增：显示不一致信息，结束加载
                        return; 
                    }

                    // 确保 selectedDate 和 bookingStartDate 已正确设置
                    if (!this.dashboardConfig.selectedDate || !this.dashboardConfig.bookingStartDate) {
                        console.error("Dashboard: selectedDate or bookingStartDate is not set. Cannot display prices.");
                        this.bestPriceDashboard.selectedDayPrices = [];
                        this.bestPriceDashboard.message = "预订日期未选择或无效。";
                        this.dashboardLoading = false; // <<< 新增
                        return;
                    }
                    
                    const dayIndex = this.calculateDayIndex(this.dashboardConfig.selectedDate, this.dashboardConfig.bookingStartDate);
                    console.log(`Dashboard: Attempting to display prices for selectedDate: ${this.dashboardConfig.selectedDate}, bookingStartDate: ${this.dashboardConfig.bookingStartDate}, calculated dayIndex: ${dayIndex}`);

                    if (this.bestPriceDashboard.dailyPricesByDay && 
                        this.bestPriceDashboard.dailyPricesByDay[dayIndex] && 
                        this.bestPriceDashboard.dailyPricesByDay[dayIndex].prices) {
                        
                        const pricesForDayByStdKey = this.bestPriceDashboard.dailyPricesByDay[dayIndex].prices;
                        let pricesArrayForDisplay = [];
                        
                        this.bookingTypes.forEach(stdKey => {
                            const priceDataForStdKey = pricesForDayByStdKey[stdKey];
                            if (priceDataForStdKey) { 
                                pricesArrayForDisplay.push({
                                    cargoType: priceDataForStdKey.displayCargoType,
                                    bestPrice: priceDataForStdKey.price,
                                    source: priceDataForStdKey.source
                                });
                    } else {
                                const cargoDisplayName = (this.cargoConfig && this.cargoConfig[stdKey] && this.cargoConfig[stdKey].name) ? this.cargoConfig[stdKey].name : stdKey;
                                pricesArrayForDisplay.push({
                                    cargoType: cargoDisplayName,
                                    bestPrice: null,
                                    source: '数据缺失'
                                });
                            }
                        });

                        if (pricesArrayForDisplay.length > 0) {
                            this.bestPriceDashboard.selectedDayPrices = pricesArrayForDisplay;
                            const allExpectedPresent = pricesArrayForDisplay.length === this.expectedCargoTypesCount && pricesArrayForDisplay.every(p => p.bestPrice !== null);
                            if (allExpectedPresent) {
                                this.bestPriceDashboard.message = `显示日期 ${this.dashboardConfig.selectedDate} 的价格。`; // 这个消息会在 dashboardLoading=true 时显示
                            } else {
                                this.bestPriceDashboard.message = `日期 ${this.dashboardConfig.selectedDate} (第 ${dayIndex} 天) 的部分价格数据不完整或缺失。`;
                            }
                            console.log(`Dashboard: Successfully found and set prices for dayIndex ${dayIndex}:`, JSON.parse(JSON.stringify(this.bestPriceDashboard.selectedDayPrices)));
                            this.bestPriceDashboard.isDataValid = true; // <<< 新增/确保: 数据有效
                        } else {
                             this.bestPriceDashboard.selectedDayPrices = [];
                             this.bestPriceDashboard.message = `日期 ${this.dashboardConfig.selectedDate} (第 ${dayIndex} 天) 未找到任何价格数据。`;
                             console.warn(`Dashboard: No price data transformed for display for dayIndex ${dayIndex}. Raw pricesByStdKey:`, JSON.parse(JSON.stringify(pricesForDayByStdKey)));
                             this.bestPriceDashboard.isDataValid = false; // <<< 新增/确保: 数据无效
                        }
                    } else {
                        this.bestPriceDashboard.selectedDayPrices = [];
                        this.bestPriceDashboard.message = `在模型结果中未能找到日期 ${this.dashboardConfig.selectedDate} (第 ${dayIndex} 天) 的完整价格数据 (预期${this.expectedCargoTypesCount}条，实际找到 0 条)。`;
                        console.warn(`Dashboard: Price data not found for dayIndex ${dayIndex}. Raw dailyPricesByDay (when dayIndex entry not found):`, JSON.parse(JSON.stringify(this.bestPriceDashboard.dailyPricesByDay)));
                        this.bestPriceDashboard.isDataValid = false; // <<< 新增/确保: 数据无效
                    }
                    console.log("综合最优价格仪表盘数据已尝试更新 (固定14天)");
                    this.dashboardLoading = false; // <<< 关键：在此函数末尾设置 loading 为 false
                },
                // 修改：核心数据获取与处理方法
                async fetchAndDisplayDashboardPrices(isInitialCall = false) {
                    if (this.isFetchingDashboardPrices && !isInitialCall) {
                        console.log("Dashboard price fetch already in progress. Skipping.");
                        return;
                    }
                    this.isFetchingDashboardPrices = true;
                    this.dashboardLoading = true; // <<< 新增：开始时设置为 true
                    this.bestPriceDashboard.message = `正在为 ${this.dashboardConfig.selectedDate || '选定日期'} 获取和处理价格数据...`; // <<< 新增：设置加载消息

                        console.log("开始为仪表盘获取和处理模型数据...");

                    try {
                        const baseParams = {
                            origin: this.routeInfo ? this.routeInfo.origin : '默认始发地', // 使用 this.routeInfo
                            destination: this.routeInfo ? this.routeInfo.destination : '默认目的地', // 使用 this.routeInfo
                            distance: this.routeInfo ? this.routeInfo.distance : 1000, // 使用 this.routeInfo
                            aircraft_type: this.aircraftInfo ? this.aircraftInfo.type : 'default_aircraft', // 使用 this.aircraftInfo
                            max_payload: this.aircraftInfo ? this.aircraftInfo.max_payload : 10000, // 使用 this.aircraftInfo
                            max_volume: this.aircraftInfo ? this.aircraftInfo.max_volume : 50000, // 使用 this.aircraftInfo
                            competition_level: this.routeInfo ? (this.routeInfo.competition_level || 'medium') : 'medium',
                            market_size: this.routeInfo ? (this.routeInfo.market_size || 'medium') : 'medium',
                            season_factor: this.routeInfo ? (this.routeInfo.season_factor || 1.0) : 1.0,
                            demand_coefficient: this.routeInfo ? (this.routeInfo.demand_coefficient || 1.0) : 1.0,
                            flight_type: this.routeInfo ? (this.routeInfo.flight_type || '干线') : '干线',
                            market_share: this.routeInfo ? (this.routeInfo.market_share || 0.5) : 0.5,
                            flight_frequency: this.routeInfo ? (this.routeInfo.flight_frequency || 7) : 7,
                            // 新增：确保 booking_period 总是传递
                            booking_period: this.bookingPeriodDisplay, // 使用计算属性 14
                             // 新增：确保 gamma 和 C_D_ratio 传递给DP模型
                            gamma: this.dynamicDP.gamma,
                            C_D_ratio: this.dynamicDP.C_D_ratio,
                             // 新增：传递弹性模型的参数 (如果后端需要)
                            elasticity_params: { // 根据需要调整键名以匹配后端API
                                price_elasticities: this.elasticity.priceElasticity, // e.g. { express: -1.7, ... }
                                initial_prices: this.elasticity.initialPrices     // e.g. { express: 12, ... }
                            }
                        };
                        console.log("基础请求数据:", JSON.parse(JSON.stringify(baseParams)));

                        // 弹性模型请求
                        const elasticityRequest = {
                            ...baseParams,
                            // 弹性模型特定参数 (如果与baseParams不同)
                        };
                        console.log("弹性模型请求数据 (fetch):", JSON.parse(JSON.stringify(elasticityRequest)));
                        const elasticityResponse = await window.AirCargoAPI.calculateElasticityPricing(elasticityRequest);
                        if (!elasticityResponse || elasticityResponse.status === 'error') { // Check for status === 'error'
                            throw new Error(`弹性模型API错误: ${(elasticityResponse && elasticityResponse.message) ? elasticityResponse.message : '未知错误'}`);
                        }
                        this.modelResults.elasticity = elasticityResponse;
                        console.log("弹性模型响应 (fetch):", JSON.parse(JSON.stringify(this.modelResults.elasticity)));

                        // Ensure parsed_daily_prices_for_chart is generated if daily_prices_list is present
                        if (this.modelResults.elasticity && this.modelResults.elasticity.daily_prices_list) {
                            // First, transform the nested structure to a flat list if necessary
                            const transformedElasticityPrices = this.transformNestedDailyPricesForChart(
                                this.modelResults.elasticity.daily_prices_list,
                                this.dashboardConfig.bookingPeriod
                            );
                            // Then, parse the flat list for the chart
                            this.modelResults.elasticity.parsed_daily_prices_for_chart =
                                this.parseDailyPricesForChart(transformedElasticityPrices); // Pass the transformed list
                            console.log("Dashboard fetch: Elasticity parsed_daily_prices_for_chart re-generated from transformed data.", this.modelResults.elasticity.parsed_daily_prices_for_chart);
                        }


                        // DP模型请求
                        const dpRequest = {
                            ...baseParams,
                            // DP模型特定参数 (如果与baseParams不同)
                        };
                        console.log("DP模型请求数据 (fetch):", JSON.parse(JSON.stringify(dpRequest)));
                        const dpResponse = await window.AirCargoAPI.calculateDynamicDPPricing(dpRequest);
                         if (!dpResponse || dpResponse.status === 'error') { // Check for status === 'error'
                            throw new Error(`动态规划模型API错误: ${(dpResponse && dpResponse.message) ? dpResponse.message : '未知错误'}`);
                        }
                        this.modelResults.dynamicDP = dpResponse;
                        console.log("DP模型响应 (fetch):", JSON.parse(JSON.stringify(this.modelResults.dynamicDP)));

                        this.modelResults.show = true; // 标记模型结果已更新
                        
                        // 数据获取并处理完毕后，调用 checkAndDisplayDashboardBestPrice 来更新UI
                        // this.checkAndDisplayDashboardBestPrice(); // 移动到 finally 块中或者在下面确保执行
                        
                    } catch (error) {
                        console.error("获取仪表盘价格时出错:", error);
                        this.bestPriceDashboard.message = `获取价格数据失败: ${error.message}`;
                        this.bestPriceDashboard.isDataValid = false;
                        this.bestPriceDashboard.selectedDayPrices = null;
                        // this.dashboardLoading = false; // 移动到 finally
                    } finally {
                        this.isFetchingDashboardPrices = false; // 无论成功或失败，都重置标记
                        // 确保调用 checkAndDisplayDashboardBestPrice 来更新UI并关闭加载状态
                        this.checkAndDisplayDashboardBestPrice(); 
                        // dashboardLoading 会在 checkAndDisplayDashboardBestPrice 内部被设置为 false
                        console.log("仪表盘价格获取流程结束 (fetchAndDisplayDashboardPrices.finally). isFetching:", this.isFetchingDashboardPrices, "dashboardLoading should be false after checkAndDisplay...");
                    }
                },
                // 测试API连接
                async testAPIConnection() {
                    try {
                        console.log("测试API连接...");
                        const response = await fetch(`${this.apiBaseUrl}/api/health`); // 使用变量
                        const result = await response.json();
                        if (result.status === 'ok') {
                            console.log("API连接正常:", result.message);
                        } else {
                            console.error("API连接测试失败:", result);
                            alert("API服务器连接测试失败，请确保服务器已启动，部分功能可能不可用。");
                        }
                    } catch (error) {
                        console.error("无法连接到API服务器:", error);
                        alert(`无法连接到API服务器 (${this.apiBaseUrl})，请确保服务器已启动，部分功能可能不可用。`);
                    }
                },
                // 加载保存的配置
                loadSavedConfigurations() {
                    console.log("loadSavedConfigurations 开始...");
                    let needsPriceFetch = false; // Flag to determine if fetch is needed after this function

                    if (!this.aircraftOptions || this.aircraftOptions.length === 0 || !this.routeOptions || this.routeOptions.length === 0) {
                        console.warn("航线或机型选项尚未加载或为空，loadSavedConfigurations 将部分跳过或推迟。");
                        if (this.routeOptions && this.routeOptions.length > 0 && this.dashboardConfig.selectedRouteIndex === null) {
                            console.log("尝试设置默认航线 (机型未绪)...");
                            this.setDefaultRouteConfig(true); // isInitialLoad = true
                        }
                        if (this.aircraftOptions && this.aircraftOptions.length > 0 && !this.dashboardConfig.selectedAircraftType) {
                             console.log("尝试设置默认机型 (航线未绪)...");
                            this.setDefaultAircraftConfig(true); // isInitialLoad = true
                        }
                        // Return early, data fetch will be triggered by watchers if defaults are set, or by loadInitialData
                        return false; 
                    }

                    console.log("loadSavedConfigurations: 当前 this.aircraftOptions:", JSON.parse(JSON.stringify(this.aircraftOptions)));
                    console.log("loadSavedConfigurations: 当前 this.routeOptions:", JSON.parse(JSON.stringify(this.routeOptions)));

                    let routeSetByStorage = false;
                    const savedRouteId = localStorage.getItem('selectedRouteId');
                    console.log("从 localStorage 读取的 savedRouteId:", savedRouteId);
                    if (savedRouteId) {
                        const foundRouteIndex = this.routeOptions.findIndex(r => (r.origin + '_' + r.destination) === savedRouteId);
                        if (foundRouteIndex !== -1) {
                            if (this.dashboardConfig.selectedRouteIndex !== foundRouteIndex) {
                                this.dashboardConfig.selectedRouteIndex = foundRouteIndex; // This will trigger watcher if changed
                                this.routeInfo = { ...this.routeOptions[foundRouteIndex] };
                                this.updateModelParametersForRoute(foundRouteIndex);
                                console.log("已加载并匹配保存的航线配置:", JSON.parse(JSON.stringify(this.routeInfo)));
                                routeSetByStorage = true;
                                needsPriceFetch = true; // Route changed from default/previous
                            } else {
                                // Route is already the saved one, ensure info is set
                                this.routeInfo = { ...this.routeOptions[foundRouteIndex] };
                                this.updateModelParametersForRoute(foundRouteIndex); // Ensure params are updated
                                routeSetByStorage = true;
                            }
                        } else {
                            console.warn(`localStorage 中的航线ID '${savedRouteId}' 在列表中未找到.`);
                        }
                    }

                    if (!routeSetByStorage && (this.dashboardConfig.selectedRouteIndex === null || typeof this.routeOptions[this.dashboardConfig.selectedRouteIndex] === 'undefined')) {
                        console.log("未从localStorage加载航线，设置默认航线...");
                        this.setDefaultRouteConfig(true); // isInitialLoad = true
                        needsPriceFetch = true; // Default was set
                    } else if (routeSetByStorage && !this.routeInfo) { // Edge case: index set, but info not yet
                        this.routeInfo = { ...this.routeOptions[this.dashboardConfig.selectedRouteIndex] };
                        this.updateModelParametersForRoute(this.dashboardConfig.selectedRouteIndex);
                    }


                    let aircraftSetByStorage = false;
                    const savedAircraftType = localStorage.getItem('selectedAircraftType');
                    console.log("从 localStorage 读取的 savedAircraftType:", savedAircraftType);
                    if (savedAircraftType) {
                        const foundAircraft = this.aircraftOptions.find(ac => ac.type === savedAircraftType);
                        if (foundAircraft) {
                            if (this.dashboardConfig.selectedAircraftType !== savedAircraftType) {
                                this.dashboardConfig.selectedAircraftType = savedAircraftType; // This will trigger watcher if changed
                                this.aircraftInfo = { ...foundAircraft };
                                this.updateModelParametersForAircraft(savedAircraftType);
                                console.log("已加载并匹配保存的机型配置:", JSON.parse(JSON.stringify(this.aircraftInfo)));
                                aircraftSetByStorage = true;
                                needsPriceFetch = true; // Aircraft changed
                            } else {
                                this.aircraftInfo = { ...foundAircraft };
                                this.updateModelParametersForAircraft(savedAircraftType);
                                aircraftSetByStorage = true;
                            }
                        } else {
                            console.warn(`localStorage 中的机型 '${savedAircraftType}' 在从 API 加载的列表中未找到.`);
                        }
                    }

                    if (!aircraftSetByStorage && !this.dashboardConfig.selectedAircraftType) {
                        console.log("未从localStorage加载机型，设置默认机型...");
                        this.setDefaultAircraftConfig(true); // isInitialLoad = true
                        needsPriceFetch = true; // Default was set
                    } else if (aircraftSetByStorage && !this.aircraftInfo) { // Edge case
                         const currentSelectedAircraft = this.aircraftOptions.find(ac => ac.type === this.dashboardConfig.selectedAircraftType);
                         if(currentSelectedAircraft) {
                            this.aircraftInfo = { ...currentSelectedAircraft };
                            this.updateModelParametersForAircraft(this.dashboardConfig.selectedAircraftType);
                         }
                    }
                    
                    // Final check for parameter updates if not done by setters/watchers
                    if (!this.aircraftInfo && this.dashboardConfig.selectedAircraftType) {
                         this.updateModelParametersForAircraft(this.dashboardConfig.selectedAircraftType);
                    }
                     if (!this.routeInfo && this.dashboardConfig.selectedRouteIndex !== null && this.routeOptions[this.dashboardConfig.selectedRouteIndex]) {
                         this.updateModelParametersForRoute(this.dashboardConfig.selectedRouteIndex);
                    }


                    console.log("loadSavedConfigurations 结束. dashboardConfig:", JSON.parse(JSON.stringify(this.dashboardConfig)), "routeInfo:", this.routeInfo, "aircraftInfo:", this.aircraftInfo);
                    return needsPriceFetch; // Return if an explicit fetch might be needed by the caller
                },

                setDefaultRouteConfig(isInitialLoad = false) {
                    if (this.routeOptions && this.routeOptions.length > 0) {
                        const newIndex = 0;
                        if (this.dashboardConfig.selectedRouteIndex !== newIndex) {
                            this.dashboardConfig.selectedRouteIndex = newIndex; // Watcher will handle the rest if changed
                        } else { // If already default, ensure info is set and params updated
                            this.routeInfo = { ...this.routeOptions[newIndex] };
                            this.updateModelParametersForRoute(newIndex);
                        }
                        console.log("使用默认航线配置 (列表第一个):", JSON.parse(JSON.stringify(this.routeOptions[newIndex])));
                        if (!isInitialLoad && this.dashboardConfig.selectedAircraftType) { // Only call if not initial load and aircraft is also set
                           this.handleRouteOrAircraftChange();
                        }
                    } else {
                        console.warn("航线选项为空，无法设置默认航线。");
                        this.dashboardConfig.selectedRouteIndex = null;
                        this.routeInfo = null;
                    }
                },

                setDefaultAircraftConfig(isInitialLoad = false) {
                    console.log("setDefaultAircraftConfig called. isInitialLoad:", isInitialLoad);
                    console.log("Current this.aircraftOptions:", JSON.parse(JSON.stringify(this.aircraftOptions))); // ADD THIS LOG

                    if (this.aircraftOptions && this.aircraftOptions.length > 0) {
                        const defaultAircraft = this.aircraftOptions[0];
                        // Explicitly check if defaultAircraft itself and defaultAircraft.type are valid
                        if (defaultAircraft && typeof defaultAircraft.type === 'string' && defaultAircraft.type.trim() !== '') {
                            if (this.dashboardConfig.selectedAircraftType !== defaultAircraft.type) {
                                this.dashboardConfig.selectedAircraftType = defaultAircraft.type; // Watcher handles rest
                            } else { 
                                this.aircraftInfo = { ...defaultAircraft };
                                this.updateModelParametersForAircraft(defaultAircraft.type);
                            }
                            console.log(`使用默认机型配置 (列表第一个 '${defaultAircraft.type}'):`, JSON.parse(JSON.stringify(defaultAircraft)));
                             if (!isInitialLoad && this.dashboardConfig.selectedRouteIndex !== null) { 
                               this.handleRouteOrAircraftChange();
                            }
                        } else {
                            console.error("setDefaultAircraftConfig: 默认机型对象无效，或其 'type' 属性缺失/无效:", JSON.parse(JSON.stringify(defaultAircraft)));
                            // Attempt to find the first valid aircraft in the list as a fallback
                            const firstValidAircraft = this.aircraftOptions.find(ac => ac && typeof ac.type === 'string' && ac.type.trim() !== '');
                            if (firstValidAircraft) {
                                console.warn("setDefaultAircraftConfig: 回退到列表中的第一个有效机型:", firstValidAircraft.type);
                                if (this.dashboardConfig.selectedAircraftType !== firstValidAircraft.type) {
                                    this.dashboardConfig.selectedAircraftType = firstValidAircraft.type;
                                } else {
                                    this.aircraftInfo = { ...firstValidAircraft };
                                    this.updateModelParametersForAircraft(firstValidAircraft.type);
                                }
                                if (!isInitialLoad && this.dashboardConfig.selectedRouteIndex !== null) {
                                   this.handleRouteOrAircraftChange();
                                }
                            } else {
                                console.error("setDefaultAircraftConfig: aircraftOptions 中未找到任何有效的机型配置。");
                                this.dashboardConfig.selectedAircraftType = null;
                                this.aircraftInfo = null;
                            }
                        }
                    } else {
                        console.warn("机型选项为空，无法设置默认机型。");
                        this.dashboardConfig.selectedAircraftType = null;
                        this.aircraftInfo = null;
                    }
                },
                validateConfigWithResults() {
                    const selectedRoute = this.routeOptions[this.dashboardConfig.selectedRouteIndex];
                    const selectedAircraft = this.aircraftOptions.find(a => a.type === this.dashboardConfig.selectedAircraftType);

                    const elasticityResult = this.modelResults.elasticity;
                    const dynamicDPResult = this.modelResults.dynamicDP;

                    let isConsistent = true;
                    let mismatchReason = "";

                    // 检查弹性模型 - 修改为同时检查bookingDaysPriceTable和dayPriceTable
                    if (!elasticityResult || (!elasticityResult.bookingDaysPriceTable && !elasticityResult.dayPriceTable)) {
                        isConsistent = false;
                        mismatchReason += "弹性模型结果缺失或格式不正确; ";
                    }

                    // 检查动态规划模型 - 放宽检查条件
                    if (!dynamicDPResult || (!dynamicDPResult.bookingDaysPriceTable && !dynamicDPResult.baseRevenue)) {
                        isConsistent = false;
                        mismatchReason += "动态规划模型结果缺失或格式不正确; ";
                    }

                    // 检查航线信息
                    if (!selectedRoute || !selectedAircraft) {
                        isConsistent = false;
                        mismatchReason += "无法获取航线或机型信息; ";
                    }

                    // 检查预订期 - 简化检查，仅确保日期在合理范围
                    if (this.dashboardConfig.currentBookingStart && this.dashboardConfig.currentBookingEnd) {
                        const today = new Date(this.dashboardConfig.selectedDate);
                        const start = new Date(this.dashboardConfig.currentBookingStart);
                        const end = new Date(this.dashboardConfig.currentBookingEnd);
                        
                        // 放宽日期范围检查，允许一定的误差
                        if (today < new Date(start.getTime() - 86400000*2) || 
                            today > new Date(end.getTime() + 86400000*2)) {
                            isConsistent = false;
                            mismatchReason += "选择的日期不在当前开放定舱期内; ";
                        }
                    }

                    return { isConsistent, mismatchReason };
                },
                calculateDayIndex(selectedDate, bookingStart) {
                    const start = new Date(bookingStart);
                    const end = new Date(this.dashboardConfig.currentBookingEnd);
                    const today = new Date(selectedDate);

                    if (today < start) return 1;
                    if (today > end) return 14;

                    const diffTime = Math.abs(today - start);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    return Math.min(14, Math.max(1, Math.ceil(diffDays / ((end - start) / 14))));
                },
                // --- 新增: 从API加载初始数据 ---
                async loadInitialData() {
                    try {
                        this.dashboardLoading = true;
                        this.bestPriceDashboard.message = "正在加载配置数据...";
                        console.log("开始从 API 加载航线和机型数据...");

                        const routesPromise = fetch(`${this.apiBaseUrl}/api/routes`).then(res => {
                            if (!res.ok) throw new Error(`获取航线失败: ${res.status} ${res.statusText}`);
                            return res.json();
                        });
                        const aircraftPromise = fetch(`${this.apiBaseUrl}/api/aircrafts`).then(res => {
                            if (!res.ok) throw new Error(`获取机型失败: ${res.status} ${res.statusText}`);
                            return res.json();
                        });

                        const [routesData, aircraftData] = await Promise.all([routesPromise, aircraftPromise]);

                        this.routeOptions = routesData || [];
                        this.aircraftOptions = aircraftData || [];
                        console.log("航线数据已加载:", JSON.parse(JSON.stringify(this.routeOptions)));
                        console.log("机型数据已加载:", JSON.parse(JSON.stringify(this.aircraftOptions)));

                        // Now that options are loaded, load saved/default selections
                        const explicitFetchNeeded = this.loadSavedConfigurations(); // This will set defaults if needed

                        // Check if configs are valid to proceed with fetching prices
                        if (this.dashboardConfig.selectedRouteIndex !== null && 
                            this.dashboardConfig.selectedAircraftType &&
                            this.routeOptions.length > 0 && 
                            this.aircraftOptions.length > 0) {
                            
                            // Ensure routeInfo and aircraftInfo are populated after defaults
                            if (!this.routeInfo && this.routeOptions[this.dashboardConfig.selectedRouteIndex]) {
                                this.routeInfo = { ...this.routeOptions[this.dashboardConfig.selectedRouteIndex]};
                                this.updateModelParametersForRoute(this.dashboardConfig.selectedRouteIndex);
                            }
                            if (!this.aircraftInfo && this.aircraftOptions.find(a => a.type === this.dashboardConfig.selectedAircraftType)) {
                                this.aircraftInfo = { ...this.aircraftOptions.find(a => a.type === this.dashboardConfig.selectedAircraftType) };
                                this.updateModelParametersForAircraft(this.dashboardConfig.selectedAircraftType);
                            }

                            console.log("初始数据和配置加载完成，触发价格获取...");
                            this.fetchAndDisplayDashboardPrices();
                        } else {
                            console.warn("loadInitialData: 未能确定有效的默认航线/机型选择，无法自动获取价格。");
                            this.dashboardLoading = false;
                            this.bestPriceDashboard.message = "请手动选择航线和机型。";
                        }

                    } catch (error) {
                        console.error("加载初始数据时出错:", error);
                        this.bestPriceDashboard.message = `加载配置数据失败: ${error.message}. 请检查API服务。`;
                        this.dashboardLoading = false;
                    }
                },
                updateModelParametersForAircraft(aircraftType) {
                    const aircraft = this.aircraftOptions.find(a => a.type === aircraftType);
                    if (aircraft) {
                        this.aircraftInfo = { ...aircraft }; // Update reactive aircraftInfo
                        console.log(`已根据机型数据(载重:${aircraft.max_payload}kg,体积:${aircraft.max_volume}cm³)更新各模型参数`);
                        
                        // Update elasticity model defaults
                        this.elasticity.aircraftType = aircraft.type;
                        // You might want to adjust other elasticity params based on aircraft if needed

                        // Update gametheory model defaults (example, if capacity needs to be set from aircraft)
                        this.gametheory.aircraftType = aircraft.type;
                        // Example: if company capacity is tied to selected aircraft, update it here.
                        // This logic depends on how your gametheory model uses aircraft_config
                        // For now, just logging and setting type.
                        // if (this.gametheory.companies && this.gametheory.companies.length > 0) {
                        //    this.gametheory.companies[0].capacity = aircraft.max_payload; // Example
                        // }


                        // Update dynamicDP model defaults
                        this.dynamicDP.capacityWeight = aircraft.max_payload;
                        this.dynamicDP.capacityVolume = aircraft.max_volume;
                        // this.dynamicDP.aircraftType = aircraft.type; // If your DP model uses type directly

                        // Update base operating cost if it's part of your aircraft config
                        // This is just an example, adjust based on your actual data structure
                        if (typeof aircraft.base_operating_cost !== 'undefined') {
                             console.log(`当前机型配置: ${JSON.stringify({ base_operating_cost: aircraft.base_operating_cost, max_payload: aircraft.max_payload, max_volume: aircraft.max_volume })}`);
                        } else {
                             console.log(`当前机型配置: ${JSON.stringify({ max_payload: aircraft.max_payload, max_volume: aircraft.max_volume })} (无运营成本信息)`);
                        }
                        
                        // If initial prices should be adjusted based on aircraft, do it here.
                        // For now, we have a note that they are not auto-adjusted.
                        console.log("注意：初始价格不再随选定机型自动调整。");

                    } else {
                        console.warn(`updateModelParametersForAircraft: 未找到类型为 '${aircraftType}' 的机型数据。`);
                    }
                },

                updateModelParametersForRoute(routeIndex) {
                    const route = this.routeOptions[routeIndex];
                    if (route) {
                        this.routeInfo = { ...route }; // Update reactive routeInfo
                        console.log(`已根据航线数据更新各模型参数: ${route.origin} -> ${route.destination}`);

                        // Update elasticity model defaults based on route
                        // e.g., this.elasticity.someRouteParam = route.someProperty;
                        // This depends on what route-specific params your elasticity model might use

                        // Update gametheory model defaults based on route
                        // e.g., if competition level or market size from route affects game theory setup
                        
                        // Update dynamicDP model defaults based on route
                        // e.g., this.dynamicDP.someRouteParam = route.someProperty;

                        // Log relevant route info for models
                        console.log(`当前航线配置 (用于模型): 始发地: ${route.origin}, 目的地: ${route.destination}, 距离: ${route.distance}`);

                    } else {
                        console.warn(`updateModelParametersForRoute: 未找到索引为 '${routeIndex}' 的航线数据。`);
                    }
                },

                // 确保 handleRouteOrAircraftChange 也存在
                handleRouteOrAircraftChange() {
                    console.log("航线或机型已更改，重新获取仪表盘价格...");
                    localStorage.setItem('selectedRouteId', (this.routeInfo ? (this.routeInfo.origin + '_' + this.routeInfo.destination) : null));
                    localStorage.setItem('selectedAircraftType', (this.aircraftInfo ? this.aircraftInfo.type : null));
                    this.fetchAndDisplayDashboardPrices();
                },
                getFormattedDate(date) {
                    if (!(date instanceof Date)) {
                        date = new Date(date);
                    }
                    if (isNaN(date.getTime())) {
                        return new Date().toISOString().split('T')[0]; // Fallback to current date if invalid
                    }
                    const year = date.getFullYear();
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const day = date.getDate().toString().padStart(2, '0');
                    return `${year}-${month}-${day}`;
                },
                updateDashboardDateConstraints() {
                    this.todayDate = this.getFormattedDate(new Date()); // Actual today
                    if (!this.dashboardConfig.selectedDate || new Date(this.dashboardConfig.selectedDate) < new Date(this.todayDate)) {
                         this.dashboardConfig.selectedDate = this.todayDate;
                    }
                    this.calculateCurrentBookingPeriod(); // Recalculate displayed range
                },
                async fetchDPModelData(basePayload) {
                    if (!this.dashboardConfig.selectedDate) {
                        console.error("DP模型请求错误: 未选择预订开始日期");
                        return { error: true, message: "请选择预订开始日期" };
                    }
                    const bookingStartDate = this.getFormattedDate(this.dashboardConfig.selectedDate);
                    const endDate = new Date(bookingStartDate);
                    endDate.setDate(endDate.getDate() + 13);
                    const bookingEndDate = this.getFormattedDate(endDate);

                    const dpPayload = {
                        ...basePayload,
                        booking_period: 14, // Fixed 14-day period
                        gamma: this.dpModelConfig.gamma,
                        C_D_ratio: this.dpModelConfig.c_d_ratio,
                        booking_start_date: bookingStartDate,
                        booking_end_date: bookingEndDate,
                    };
                    console.log("DP模型请求数据 (fetch):", dpPayload);
                    try {
                        const result = await apiClient.calculateDynamicDPPricing(dpPayload);
                        console.log("DP模型响应:", result);
                        if (result && result.status === 'success') { // Check for overall success
                            // Ensure dailyPrices exists and is an array before processing
                            const bookingDaysPriceTable = result.bookingDaysPriceTable || [];
                            return {
                                ...result,
                                priceTable: result.priceTable || [], // ensure priceTable is an array
                                bookingDaysPriceTable: bookingDaysPriceTable 
                            };
                        } else {
                            return { 
                                error: true, 
                                message: result.message || "DP模型计算失败或返回非成功状态",
                                priceTable: [], // Default to empty array on error
                                bookingDaysPriceTable: [] // Default to empty array on error
                            };
                        }
                    } catch (error) {
                        console.error("获取DP模型数据失败:", error);
                        return { 
                            error: true, 
                            message: `获取DP模型数据时出错: ${error.message}`,
                            priceTable: [],
                            bookingDaysPriceTable: [] 
                        };
                    }
                },

                // 新增：辅助方法，用于获取模型API所需的基础参数
                getBaseModelParams() {
                    const routeId = this.routeInfo ? this.routeInfo.id : null; // Use routeInfo.id
                    const aircraftType = this.aircraftInfo ? this.aircraftInfo.type : null; // Use aircraftInfo.type

                    let selectedRoute = this.routeInfo;
                    let selectedAircraft = this.aircraftInfo;

                    // Fallback if routeInfo/aircraftInfo are not fully populated but IDs/types are in dashboardConfig
                    if (!selectedRoute && this.dashboardConfig.selectedRouteIndex !== null && this.routeOptions.length > this.dashboardConfig.selectedRouteIndex) {
                        selectedRoute = this.routeOptions[this.dashboardConfig.selectedRouteIndex];
                    }
                     if (!selectedAircraft && this.dashboardConfig.selectedAircraftType && this.aircraftOptions.length > 0) {
                        selectedAircraft = this.aircraftOptions.find(a => a.type === this.dashboardConfig.selectedAircraftType);
                    }


                    if (!selectedRoute || !selectedAircraft) {
                        console.error("getBaseModelParams: 无法获取选定的航线或机型信息。 RouteID from info:", routeId, "AircraftType from info:", aircraftType);
                        return { error: "航线或机型信息不完整" }; 
                    }
                    
                    const baseParams = {
                        origin: selectedRoute.origin,
                        destination: selectedRoute.destination,
                        distance: selectedRoute.distance,
                        competition_level: selectedRoute.competition_level || 'medium', 
                        demand_coefficient: selectedRoute.demand_coefficient || 1.0, 
                        distance_category: selectedRoute.distance_category || 'medium', 
                        flight_frequency: selectedRoute.flight_frequency || 7,
                        flight_type: selectedRoute.flight_type || 'mixed',
                        market_share: selectedRoute.market_share || 0.3,
                        market_size: selectedRoute.market_size || 'medium',
                        popularity: selectedRoute.popularity || 'medium',
                        season_factor: selectedRoute.season_factor || 1.0,
                        
                        aircraft_type: selectedAircraft.type,
                        max_payload: selectedAircraft.max_payload,
                        max_volume: selectedAircraft.max_volume,
                        base_operating_cost: selectedAircraft.base_operating_cost,
                        route_id: selectedRoute.id // Explicitly add route_id here
                    };
                    
                    Object.keys(baseParams).forEach(key => {
                        if (baseParams[key] === undefined || baseParams[key] === null) {
                            console.warn(`getBaseModelParams: Parameter '${key}' was undefined/null for route ${selectedRoute.id} and aircraft ${selectedAircraft.type}. Removing from params.`);
                            delete baseParams[key];
                        }
                    });
                    
                    return baseParams;
                },

                transformNestedDailyPricesForChart(nestedDailyPricesList, bookingPeriod = 14) {
                    if (!nestedDailyPricesList || !Array.isArray(nestedDailyPricesList)) {
                        console.warn("transformNestedDailyPricesForChart: Input is not a valid array.", nestedDailyPricesList);
                        return [];
                    }
                    const flatList = [];
                    const today = new Date(this.dashboardConfig.bookingStartDate || new Date());

                    nestedDailyPricesList.forEach(group => {
                        if (group && group.cargoType && Array.isArray(group.dailyPrices)) {
                            group.dailyPrices.forEach(dailyPrice => {
                                if (dailyPrice && typeof dailyPrice.day === 'number' && typeof dailyPrice.price === 'number') {
                                    // Calculate date based on bookingStartDate and day number
                                    const currentDate = new Date(today);
                                    currentDate.setDate(today.getDate() + dailyPrice.day - 1); // day is 1-indexed

                                    flatList.push({
                                        cargoType: group.cargoType.trim(),
                                        date: currentDate.toISOString().split('T')[0], // Format as YYYY-MM-DD
                                        price: dailyPrice.price
                                    });
                                } else {
                                    console.warn("transformNestedDailyPricesForChart: Skipping invalid daily price entry in group:", group.cargoType, dailyPrice);
                                }
                            });
                        } else {
                            console.warn("transformNestedDailyPricesForChart: Skipping invalid group in nested list:", group);
                        }
                    });
                    console.log("transformNestedDailyPricesForChart - Transformed list:", JSON.parse(JSON.stringify(flatList)));
                    return flatList;
                },

                parseDailyPricesForChart(dailyPricesList) {
                    if (!dailyPricesList || !Array.isArray(dailyPricesList) || dailyPricesList.length === 0) {
                        console.warn("parseDailyPricesForChart: dailyPricesList 数据缺失或无效，无法解析图表数据。", dailyPricesList);
                        return { labels: [], datasets: [] };
                    }

                    const datasetsMap = new Map(); // 用于存储每种货物类型的数据点
                    const labels = new Set();      // 用于存储所有日期（X轴标签）

                    dailyPricesList.forEach(item => {
                        if (!item || typeof item.cargoType !== 'string' || typeof item.date !== 'string' || typeof item.price !== 'number') {
                            console.warn("parseDailyPricesForChart: 跳过无效的数据项", item);
                            return;
                        }
                        const cargoType = item.cargoType.trim();
                        const date = item.date;
                        const price = item.price;

                        labels.add(date); // 添加日期到X轴标签

                        if (!datasetsMap.has(cargoType)) {
                            datasetsMap.set(cargoType, {
                                label: cargoType,
                                data: [],
                                // 在这里可以为不同货物类型预设不同的颜色
                                borderColor: this.getBorderColorForCargoType(cargoType), // 需要实现 getBorderColorForCargoType
                                backgroundColor: this.getBackgroundColorForCargoType(cargoType), // 需要实现 getBackgroundColorForCargoType
                                tension: 0.1,
                                fill: false
                            });
                        }
                        // 按日期顺序添加数据，这里假设API返回的数据已经是按日期排序的
                        // 如果不是，则需要先对labels进行排序，然后填充数据
                        datasetsMap.get(cargoType).data.push({ x: date, y: price });
                    });

                    // 将Set转换为排序后的数组，作为图表的labels
                    const sortedLabels = Array.from(labels).sort((a, b) => new Date(a) - new Date(b));
                    
                    // 确保每个dataset的data数组与sortedLabels对齐
                    const finalDatasets = Array.from(datasetsMap.values()).map(dataset => {
                        const newData = sortedLabels.map(label => {
                            const dataPoint = dataset.data.find(dp => dp.x === label);
                            return dataPoint ? dataPoint.y : null; // 如果某日期没有价格，则为null
                        });
                        return { ...dataset, data: newData };
                    });
                    
                    console.log("parseDailyPricesForChart - 解析后的图表数据:", { labels: sortedLabels, datasets: finalDatasets });
                    return {
                        labels: sortedLabels,
                        datasets: finalDatasets
                    };
                },

                // 辅助方法：为不同货物类型获取边框颜色 (示例)
                getBorderColorForCargoType(cargoType) {
                    switch (cargoType) {
                        case '快件': return 'rgba(255, 99, 132, 1)';
                        case '鲜活': return 'rgba(54, 162, 235, 1)';
                        case '普货': return 'rgba(75, 192, 192, 1)';
                        default: return 'rgba(201, 203, 207, 1)';
                    }
                },

                // 辅助方法：为不同货物类型获取背景颜色 (示例)
                getBackgroundColorForCargoType(cargoType) {
                    // 可以与borderColor相同，或者使用稍浅的颜色
                    switch (cargoType) {
                        case '快件': return 'rgba(255, 99, 132, 0.2)';
                        case '鲜活': return 'rgba(54, 162, 235, 0.2)';
                        case '普货': return 'rgba(75, 192, 192, 0.2)';
                        default: return 'rgba(201, 203, 207, 0.2)';
                    }
                },

            },
            created() {
                // 清理可能存在的图表实例
                console.log("组件创建，确保所有图表被清理");
                
                // 清理所有常用图表ID
                const chartIds = [
                    'dashboardRevenueChart',
                    'dashboardUtilizationChart',
                    'priceOptimizationChart',
                    'computationSpeedChart',
                    'marketSensitivityChart', 
                    'predictionAccuracyChart',
                    'adaptabilityChart',
                    'elasticityChart',
                    'gametheoryChart',
                    'dynamicDPChart'
                ];
                
                chartIds.forEach(id => resetChart(id));

                // 在 created 阶段计算初始预订期 (this also updates this.todayDate)
                this.calculateCurrentBookingPeriod();
                // 在 created 阶段计算今天的日期 (确保在 mounted 之前可用)
                // this.todayDate = new Date().toISOString().split('T')[0]; // DELETED_LINE
            },
            mounted() {
                console.log("组件挂载完成");
                 // 在 mounted 阶段设置默认选择日期并加载数据
                this.ensureValidSelectedDate(); // 确保 selectedDate 在范围内 (现在会考虑 todayDate and trigger cycle calculation)

                    console.log("组件挂载后初始化仪表板");
                    this.initializeDashboardCharts();
                    
                // 更新仪表板模拟数据 (这部分可能可以移除，因为会 fetch 真实数据)
                    this.dashboardData = {
                    elasticity: { improvement: 16.8 }, // 简化
                    gametheory: { improvement: 23.8 }, // 简化
                    dynamicDP: { improvement: 20.5 } // 简化
                    };
                    
                // 修改: 调用新的加载数据方法，而不是直接加载 localStorage
                // this.loadSavedConfigurations(); // OLD LINE
                this.loadInitialData(); // NEW LINE
                    
                    // 测试API连接
                    this.testAPIConnection();

                // 移除: 在 mounted 中设置默认预订期 (已固定)
                // const initialRoute = ...

                // 修改: 移除首次加载时获取价格数据，由 loadInitialData() 内部处理
                // this.fetchAndDisplayDashboardPrices(); // OLD LINE
            },
            unmounted() {
                console.log("组件即将销毁，清理所有图表实例");
                // 清理所有图表实例
                Object.keys(chartInstances).forEach(id => {
                    resetChart(id);
                });
            }
        });
        
        // 挂载Vue应用
        app.mount('#app');
    </script>
</body>
</html> 